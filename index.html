<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>OreStellar</title>

<!-- Google Font: Orbitron -->
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet">

<!-- LZString for URL compression -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>

<style>
/* ===== BASE ===== */
html,body{margin:0;padding:0;height:100%;overflow:hidden;background:#000;font-family:monospace;color:#fff;}
canvas#starfield{position:fixed;top:0;left:0;width:100%;height:100%;z-index:0;pointer-events:none;}

/* Container */
.container-wrapper{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;gap:20px;padding:20px;z-index:2;position:relative;}

/* Logo */
#myHeader{display:flex;justify-content:center;align-items:center;flex-direction:column;text-align:center;width:100%;max-width:650px;margin-bottom:30px;cursor:pointer;z-index:2;}
#logoText{display:inline;font-family:'Orbitron',sans-serif;font-weight:700;font-size:4.5rem;letter-spacing:0;color:rgba(255,255,255,0.1);transform:skewX(-8deg);}
#logoText span{display:inline;color:rgba(255,255,255,0.1);text-shadow:none;}
@keyframes softGlow{0%,100%{text-shadow:0 0 5px #fff;color:rgba(255,255,255,0.75);}50%{text-shadow:0 0 15px #fff;color:rgba(255,255,255,1);}}
@keyframes flickerRapid{0%,20%,40%,60%,80%,100%{color: rgba(255,255,255,1);text-shadow:0 0 10px #fff;}10%,30%,50%,70%,90%{color: rgba(255,255,255,0.1);text-shadow:none;}}
@keyframes flickerQuick{0%,50%,100%{color: rgba(255,255,255,0.1);text-shadow:none;}25%,75%{color: rgba(255,255,255,1);text-shadow:0 0 10px #fff;}}

/* Main Container */
.main-container{width:650px;max-width:90%;padding:30px;display:flex;flex-direction:column;justify-content:center;align-items:center;background-color:rgba(20,20,20,0.92);border-radius:15px;z-index:2;}
.main-container textarea#message{display:block;margin:0 auto;width:92%;font-size:18px;padding:18px;border-radius:10px;resize:vertical;background-color:rgba(17,17,17,0.97);color:#fff;border:1px solid #333;text-align:left;font-family:'Share Tech Mono',monospace;box-shadow:inset 0 0 5px #111;transition: all 0.2s ease-in-out;}
.main-container textarea#message::placeholder{color:#fff;opacity:0.6;}
textarea#message:focus{outline:none;border-color:#fff;box-shadow:inset 0 0 15px #fff,0 0 25px #fff;transition:box-shadow 0.3s ease,border-color 0.3s ease;}

/* Buttons */
.actionButton{margin-top:15px;background:linear-gradient(145deg,#161616,#242424);color:#fff;border:2px solid #ccc;border-radius:10px;padding:12px 26px;font-weight:bold;font-family:'Orbitron',sans-serif;cursor:pointer;position:relative;overflow:hidden;text-shadow:0 0 2px #fff;box-shadow:0 0 6px #ffffff33,0 0 12px #ffffff11 inset;animation:ambientGlow 3.5s ease-in-out infinite alternate;transition:all 0.35s ease;}
.actionButton:disabled{opacity:0.5;cursor:not-allowed;}
@keyframes ambientGlow{0%{box-shadow:0 0 4px #ffffff33,0 0 8px #ffffff11 inset;}100%{box-shadow:0 0 12px #ffffff88,0 0 18px #ffffff33 inset;}}

/* Contracts */
.contracts-wrapper{display:flex;justify-content:center;align-items:flex-start;gap:15px;flex-wrap:wrap;width:100%;}
.total-cost-container{width:630px;height:418px;background-size:contain;background-position:center;background-repeat:no-repeat;position:relative;border-radius:15px;box-shadow:0 4px 8px rgba(0,0,0,0.5);display:none;}
#leftContainer{background-image:url('https://raw.githubusercontent.com/OreStellar/Orestellar.github.io/refs/heads/main/images/Contract1.png');display:none;}
#totalCostContainer{background-image:url('https://raw.githubusercontent.com/OreStellar/Orestellar.github.io/refs/heads/main/images/Contract2.png');display:none;position:relative;}
#totalCostText{position:absolute;top:18px;right:20px;color:#00ff00;font-family:'Share Tech Mono',monospace;font-weight:bold;font-size:18px;text-shadow:0 0 6px #00ff00,0 0 12px #00ff00;cursor:pointer;}

/* Price Tab (circular neon) */
#priceTab{position:fixed;top:22vh;right:18px;width:48px;height:48px;border-radius:10px;background:#00ff00;color:#000;display:flex;justify-content:center;align-items:center;font-weight:700;font-size:20px;cursor:pointer;box-shadow:0 0 12px #00ff00,0 0 30px #00ff00 inset;z-index:30;transition:transform 0.18s ease, right 0.18s ease;}
#priceTab:hover{transform:translateX(-6px) scale(1.05);}

/* Floating price list */
#priceListContainer{position:fixed;top:18vh;right:78px;width:320px;max-height:60vh;overflow-y:auto;background:rgba(0,0,0,0.95);border:1px solid #00ff00;padding:10px;border-radius:10px;display:none;box-shadow:0 0 18px #00ff00;z-index:29;font-family:'Share Tech Mono',monospace;color:#00ff00;}
#priceListContainer table{width:100%;border-collapse:collapse;}
#priceListContainer th,#priceListContainer td{padding:6px 8px;border-bottom:1px solid rgba(0,255,0,0.08);font-size:13px;text-align:left;}
#priceListContainer th{font-weight:700;color:#00ff00;}

/* Summary container */
.summary-container{display:none;flex-direction:column;align-items:stretch;justify-content:flex-start;font-family:'Share Tech Mono',monospace;font-size:14px;line-height:1.4;color:#00ff00;background:rgba(0,10,0,0.95);border:2px solid #00ff00;border-radius:12px;padding:16px 20px;min-width:420px;max-width:520px;max-height:60vh;overflow-y:auto;backdrop-filter:blur(6px);box-shadow:0 0 18px rgba(0,255,0,0.25);z-index:3;}
.summary-container::-webkit-scrollbar{width:8px;}
.summary-container::-webkit-scrollbar-thumb{background:#00ff00;border-radius:6px;box-shadow:0 0 10px #00ff00;}
.summary-table{width:100%;border-collapse:collapse;table-layout:fixed;}
.summary-table th, .summary-table td {padding:8px 10px;border-bottom:1px solid rgba(0,255,0,0.06);font-size:13px;white-space:nowrap;}
.summary-table th:nth-child(1), .summary-table td:nth-child(1){text-align:left;}
.summary-table td.price, .summary-table td.quantity, .summary-table td.total-column {text-align:right;font-variant-numeric:tabular-nums;}
.summary-table tr.unrecognized td {color:#ff4444;font-weight:700;text-shadow:0 0 8px #ff3333;}
.summary-table th {color:#00ff00;text-shadow:0 0 6px #00ff00;border-bottom:1px solid rgba(0,255,0,0.15);}
.summary-total td{border-top:2px solid rgba(0,255,0,0.25);font-weight:700;text-align:right;padding-top:10px;}
.shared-ledger{font-family:'Share Tech Mono',monospace;background:rgba(0,0,0,0.98);border:none;box-shadow:none;padding:10px 14px;border-radius:6px;}
</style>
</head>
<body data-show-inventory="true">
<canvas id="starfield"></canvas>
<div class="container-wrapper">
<header id="myHeader" title="Return home">
<h1 id="logoText"><span id="ore">Ore</span><span id="stellar">Stellar</span></h1>
</header>
<div class="main-container" id="inventoryContainer">
<h3 style="font-family:'Orbitron',sans-serif;font-weight:700;color:#fff;text-shadow:0 0 8px #fff,0 0 16px #fff,0 0 24px #00ff00;">Paste Your Inventory Below</h3>
<textarea id="message" rows="8" placeholder="Compressed Ytirium 1,189,290 Ytirium 7,135.74 m3 658,723,945.20 ISK Compressed Gneiss 143,582 Gneiss 7,179.10 m3 479,780,688.82 ISK"></textarea>
<button id="submitButton" class="actionButton" disabled>Submit</button>
</div>

<div class="contracts-wrapper">
<div id="leftContainer" class="total-cost-container"></div>
<div id="summaryContainer" class="summary-container" aria-live="polite"></div>
<div id="totalCostContainer" class="total-cost-container">
<div id="totalCostText">0 ISK</div>
</div>
</div>

<div id="priceTab" title="Open price list">â‚µ</div>
<div id="priceListContainer" aria-hidden="true"></div>
<button id="shareButton" class="actionButton" style="display:none;margin-top:14px;">Share Summary</button>
</div>

<script>
// ================= STARFIELD =================
const canvas = document.getElementById('starfield');
const ctx = canvas.getContext('2d');
function resizeCanvas(){canvas.width=innerWidth;canvas.height=innerHeight;}
resizeCanvas();
addEventListener('resize', ()=>{resizeCanvas(); createStars();});
let stars=[], clusterCount=10;
function createStars(){
    stars=[];
    const centers=[];
    for(let i=0;i<clusterCount;i++) centers.push({x: Math.random()*canvas.width, y: Math.random()*canvas.height});
    const total = Math.max(80, Math.floor(canvas.width * canvas.height / 1200));
    for(let i=0;i<total;i++){
        let x,y;
        if(Math.random()<0.6){
            const c=centers[Math.floor(Math.random()*centers.length)];
            const r=Math.random()*140;
            const a=Math.random()*Math.PI*2;
            x=c.x+r*Math.cos(a);y=c.y+r*Math.sin(a);
        }else{x=Math.random()*canvas.width;y=Math.random()*canvas.height;}
        const color = Math.random()<0.9 ? '#ffffff' : (Math.random()<0.5?'#f0f0ff':'#fff0f0');
        stars.push({ x, y, size: Math.random()*1.4+0.3, color, speed: Math.random()*0.06+0.01, phase: Math.random()*Math.PI*2, twinkle: Math.random()<0.2, baseAlpha:0.85+Math.random()*0.15});
    }
}
createStars();
let lastBrightTime=0, nextBrightInterval=7000+Math.random()*7000;
function drawStars(time=0){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    if(time-lastBrightTime>nextBrightInterval){
        lastBrightTime=time;
        nextBrightInterval=7000+Math.random()*7000;
        for(let i=0;i<2;i++){
            const s=stars[Math.floor(Math.random()*stars.length)];
            s.isBright=true; s.brightStart=time; s.brightEnd=time+1200+Math.random()*1600;
        }
    }
    for(const s of stars){
        let alpha=s.baseAlpha;
        if(s.twinkle) alpha=0.5+0.4*Math.abs(Math.sin(time*0.002+s.phase));
        if(s.isBright && time>=s.brightStart && time<s.brightEnd) alpha=1;
        else if(s.isBright && time>=s.brightEnd) s.isBright=false;
        ctx.fillStyle=`rgba(255,255,255,${alpha})`;
        ctx.beginPath(); ctx.arc(s.x,s.y,s.size,0,Math.PI*2);ctx.fill();
    }
    requestAnimationFrame(drawStars);
}
requestAnimationFrame(drawStars);

// ================= LOGO ANIMATION =================
window.addEventListener('load', ()=>{
    const ore = document.getElementById('ore'), stellar = document.getElementById('stellar');
    ore.style.animation = stellar.style.animation = 'flickerRapid 0.25s linear 2';
    setTimeout(()=>{
        ore.style.animation = stellar.style.animation = 'flickerQuick 0.3s linear 1';
    }, 600);
    setTimeout(()=>{
        ore.style.animation=stellar.style.animation='softGlow 6s infinite';
    }, 1000);
});

// ================= FETCH CSV PRICES =================
let priceList = {}, canonicalNames={};
async function fetchPrices(){
    try{
        const res = await fetch('https://raw.githubusercontent.com/OreStellar/Orestellar.github.io/main/data/prices.csv');
        const txt = await res.text();
        const rows = txt.split(/\r?\n/);
        if(rows.length<2) return;
        const header = rows[0].split(',').map(h=>h.trim().toLowerCase());
        const suggestedIdx = header.findIndex(h=>h.includes('suggested buy 150%'));
        if(suggestedIdx===-1) throw new Error('Suggested Buy 150% column not found');
        for(let i=1;i<rows.length;i++){
            const row = rows[i].trim();
            if(!row) continue;
            const cols = row.split(',');
            const name = cols[0].trim();
            if(!name || /compressed/i.test(name)) continue;
            const priceRaw = parseFloat(cols[suggestedIdx]);
            if(isNaN(priceRaw)) continue;
            const normalized = name.toLowerCase().replace(/\s+/g,' ').trim();
            priceList[normalized] = Math.round(priceRaw);
            canonicalNames[normalized] = name;
        }
        buildOreMatcher(); fillPriceList();
    }catch(e){ console.error(e);}
}

// ================= ORE MATCHER =================
let oreEntries=[];
function buildOreMatcher(){
    oreEntries = Object.keys(canonicalNames).map(k=>({key:k,tokens:k.split(/\s+/).length,length:k.length}));
    oreEntries.sort((a,b)=> (b.tokens - a.tokens)||(b.length - a.length));
}

// ================= PRICE LIST FILL =================
const priceListContainer = document.getElementById('priceListContainer');
function fillPriceList(){
    const grouped = {};
    for(const k of Object.keys(canonicalNames)){
        const base = k.split(' ').slice(-1)[0];
        if(!grouped[base]) grouped[base]=[];
        grouped[base].push({name:canonicalNames[k], price:priceList[k]});
    }
    let html='<table><thead><tr><th>Ore</th><th>Price</th></tr></thead><tbody>';
    Object.keys(grouped).sort().forEach(base=>{
        grouped[base].sort((a,b)=> a.name.localeCompare(b.name)).forEach(e=>{
            html+=`<tr><td>${e.name}</td><td>${e.price.toLocaleString()}</td></tr>`;
        });
    });
    html+='</tbody></table>';
    priceListContainer.innerHTML=html;
}

// ================= PRICE TAB =================
const priceTab=document.getElementById('priceTab');
priceTab.addEventListener('click',()=>{
    priceListContainer.style.display=priceListContainer.style.display==='none'?'block':'none';
});

// ================= SUBMIT / SUMMARY =================
const messageBox=document.getElementById('message');
const submitButton=document.getElementById('submitButton');
const summaryContainer=document.getElementById('summaryContainer');

messageBox.addEventListener('input',()=>{submitButton.disabled=!messageBox.value.trim();});

submitButton.addEventListener('click',()=>{generateSummary(messageBox.value);});

function generateSummary(text){
    const lines=text.split(/\n/), summary=[];
    let totalCost=0;
    lines.forEach(line=>{
        const words=line.trim().split(/\s+/);
        if(words.length<2) return;
        let found=false;
        for(const entry of oreEntries){
            if(line.toLowerCase().includes(entry.key)){
                const qtyMatch = line.match(/[\d,]+/);
                const qty = qtyMatch?parseInt(qtyMatch[0].replace(/,/g,'')):0;
                const price = priceList[entry.key]||0;
                summary.push({name:canonicalNames[entry.key], qty, price, total:qty*price});
                totalCost+=qty*price; found=true; break;
            }
        }
        if(!found) summary.push({name:line, qty:0, price:0, total:0, unrecognized:true});
    });
    renderSummary(summary,totalCost);
}

function renderSummary(items,total){
    summaryContainer.innerHTML='';
    const table=document.createElement('table'); table.className='summary-table';
    const thead=document.createElement('thead');
    thead.innerHTML='<tr><th>Ore</th><th>Qty</th><th>Price</th><th>Total</th></tr>';
    table.appendChild(thead);
    const tbody=document.createElement('tbody');
    items.forEach(it=>{
        const tr=document.createElement('tr');
        if(it.unrecognized) tr.classList.add('unrecognized');
        tr.innerHTML=`<td>${it.name}</td><td class="quantity">${it.qty.toLocaleString()}</td><td class="price">${it.price.toLocaleString()}</td><td class="total-column">${it.total.toLocaleString()}</td>`;
        tbody.appendChild(tr);
    });
    const totalRow=document.createElement('tr'); totalRow.className='summary-total';
    totalRow.innerHTML=`<td>Total</td><td></td><td></td><td>${total.toLocaleString()}</td>`;
    tbody.appendChild(totalRow);
    table.appendChild(tbody);
    summaryContainer.appendChild(table);
    summaryContainer.style.display='flex';
    document.getElementById('totalCostText').textContent = total.toLocaleString()+' ISK';
}

fetchPrices();
</script>
</body>
</html>
