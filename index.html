<!DOCTYPE html>
<html>
<head>
<title>OreStellar</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel="stylesheet" href="https://www.w3schools.com/lib/w3-theme-black.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css">

<style>
html, body { background-color: black; color: white; margin: 0; padding: 0; height: 100%; }
body { display: flex; flex-direction: column; }
header { flex-shrink: 0; }

.container-wrapper {
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: center;
  gap: 10px;
  padding: 20px;
}

.main-container {
  width: 630px;
  height: 430px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  background-color: #333;
  border-radius: 15px;
  padding: 25px;
  box-shadow: 0 0 30px rgba(0,0,0,0.7);
}

.full-width-textarea {
  width: 100%;
  height: 200px;
  resize: none;
  box-sizing: border-box;
  margin-bottom: 10px;
}

.hidden { display: none; }

.total-cost-container {
  background-size: contain;
  background-position: center;
  background-repeat: no-repeat;
  width: 630px;
  height: 430px;
  position: relative;
  color: white;
  border-radius: 15px;
  transition: opacity 0.5s ease;
}

#totalCostText {
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  font-size: 20px;
  font-weight: bold;
  text-shadow: 0 0 10px black;
}

@keyframes pulseTextGlow {
  0%, 100% { text-shadow: 0 0 5px #b3b4b4, 0 0 10px #d5e2e1, 0 0 20px #b0b3b2; }
  50% { text-shadow: 0 0 15px #f0faf9, 0 0 15px #b8c2c1, 0 0 25px #a8adad; }
}
.quote-text {
  font-style: italic;
  font-weight: bold;
  font-size: 21px;
  color: #fff;
  animation: pulseTextGlow 2s infinite;
}

/* Submit button glow */
#submitButton {
  background-color: #ffffff;
  color: black;
  border: none;
  border-radius: 8px;
  padding: 11px 25px;
  font-weight: bold;
  cursor: pointer;
  box-shadow: 0 0 15px 3px white; 
  transition: all 0.3s ease;
  margin-top: -100px; /* lifted slightly */
}
#submitButton:hover {
  background-color: #b0ff8d;  /* light green */
  box-shadow: 0 0 25px 5px #2fff1c;
}

/* Modal */
.w3-modal {
  display:none;
  position: fixed;
  z-index:999;
  left:0; top:0;
  width:100%; height:100%;
  background-color: rgba(0,0,0,0.95);
}
.w3-modal-content {
  background-color:#111;
  margin:15% auto;
  padding:20px;
  border-radius:12px;
  color:white;
  max-width:400px;
}
.w3-display-topright {
  color:white;
  font-size:28px;
  cursor:pointer;
}
</style>
</head>
<body>

<header class="w3-container w3-theme w3-padding" id="myHeader">
  <div class="w3-center">
    <img src="images/OreStellar Header.png" alt="Header Image" style="width:300px; height:auto;">
  </div>
  <hr>
</header>

<!-- Total Price Modal -->
<div id="totalPriceModal" class="w3-modal">
  <div class="w3-modal-content w3-card w3-center">
    <span id="closeTotalModal" class="w3-button w3-display-topright">&times;</span>
    <h2>Total Contract Value</h2>
    <p id="popupTotalPrice" style="font-size: 24px; font-weight: bold;"></p>
  </div>
</div>

<div class="container-wrapper">
  <div id="leftContainer" class="total-cost-container hidden"></div>

  <div class="main-container w3-card w3-center">
    <h3 class="quote-text">Copy & Paste Your Inventory Below</h3><br>
    <textarea id="message" class="w3-input w3-border w3-round full-width-textarea" placeholder="Compressed Ytirium 99&#10;Jet Ochre 135&#10;Compressed Gneiss 10240&#10;Bistot 305115&#10;Magma Mercoxit 4055&#10;Compressed Mordunium 52600040"></textarea>
    <button id="submitButton" disabled>Submit</button>
    <div id="unrecognizedItemsContainer" class="hidden w3-container w3-card w3-center" style="margin-top:10px;">
      <p id="unrecognizedItemsText" style="color:red;"></p>
    </div>
  </div>

  <div id="totalCostContainer" class="total-cost-container hidden">
    <p id="totalCostText">0</p>
  </div>
</div>

<script>
let priceList = {};

async function loadPrices() {
  try {
    const response = await fetch('data/prices.csv');
    const csv = await response.text();
    const lines = csv.trim().split('\n');
    const headers = lines[0].split(',');
    const priceIndex = headers.findIndex(h => h.toLowerCase().includes('150%'));
    for (let i=1; i<lines.length; i++) {
      const cols = lines[i].split(',');
      const ore = cols[0].trim();
      const price = parseFloat(cols[priceIndex]);
      if (!isNaN(price)) priceList[ore] = price;
    }
    document.getElementById('submitButton').disabled = false;
  } catch (e) {
    console.error('Error loading CSV', e);
  }
}

function formatNumber(n) {
  return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

function showContent() {
  const text = document.getElementById('message').value;
  const regex = /([\w\s]+?)\s+(\d+)/g;
  let match, total = 0, invalid = [];
  while ((match = regex.exec(text)) !== null) {
    const name = match[1].trim();
    const qty = parseInt(match[2]);
    if (priceList[name]) total += qty * priceList[name];
    else invalid.push(name);
  }

  const formatted = formatNumber(total.toFixed(2));
  document.getElementById('totalCostText').innerText = formatted;
  document.getElementById('popupTotalPrice').innerText = formatted + " ISK";

  // Show PNGs
  const left = document.getElementById('leftContainer');
  const right = document.getElementById('totalCostContainer');
  left.style.backgroundImage = "url('images/Contract 1.png')";
  right.style.backgroundImage = "url('images/Contract 2.png')";
  left.classList.remove('hidden');
  right.classList.remove('hidden');

  // Modal
  document.getElementById('totalPriceModal').style.display = 'block';

  // Show unrecognized if any
  const unrecognized = document.getElementById('unrecognizedItemsContainer');
  if (invalid.length) {
    document.getElementById('unrecognizedItemsText').innerText = 'Unrecognized: ' + invalid.join(', ');
    unrecognized.classList.remove('hidden');
  } else {
    unrecognized.classList.add('hidden');
  }
}

// Event listeners
document.getElementById('submitButton').addEventListener('click', showContent);
document.getElementById('closeTotalModal').addEventListener('click', () => {
  document.getElementById('totalPriceModal').style.display = 'none';
});
window.onclick = (e) => {
  if (e.target === document.getElementById('totalPriceModal')) {
    document.getElementById('totalPriceModal').style.display = 'none';
  }
};

loadPrices();
</script>
</body>
</html>
