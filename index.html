<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>OreStellar</title>

<!-- Google Font: Orbitron -->
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet">

<!-- LZString for URL compression -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>

<style>
html,body{margin:0;padding:0;height:100%;overflow:hidden;background:black;font-family:monospace;color:white;}
canvas#starfield{position:fixed;top:0;left:0;width:100%;height:100%;z-index:0;pointer-events:none;}

/* Container */
.container-wrapper{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;gap:20px;padding:20px;z-index:2;position:relative;}

/* Logo */
#myHeader{display:flex;justify-content:center;align-items:center;flex-direction:column;text-align:center;width:100%;max-width:650px;margin-bottom:30px;cursor:pointer;z-index:2;}
#logoText{display:inline;font-family:'Orbitron',sans-serif;font-weight:700;font-size:4.5rem;letter-spacing:0;color:rgba(255,255,255,0.1);transform:skewX(-8deg);}
#logoText span{display:inline;color:rgba(255,255,255,0.1);text-shadow:none;}
@keyframes softGlow{0%,100%{text-shadow:0 0 5px #fff;color:rgba(255,255,255,0.75);}50%{text-shadow:0 0 15px #fff;color:rgba(255,255,255,1);}}
@keyframes flickerRapid{0%,20%,40%,60%,80%,100%{color: rgba(255,255,255,1);text-shadow:0 0 10px #fff;}10%,30%,50%,70%,90%{color: rgba(255,255,255,0.1);text-shadow:none;}}
@keyframes flickerQuick{0%,50%,100%{color: rgba(255,255,255,0.1);text-shadow:none;}25%,75%{color: rgba(255,255,255,1);text-shadow:0 0 10px #fff;}}

/* Main Container */
.main-container{width:650px;max-width:90%;padding:30px;display:flex;flex-direction:column;justify-content:center;align-items:center;background-color:rgba(20,20,20,0.92);border-radius:15px;}
.main-container textarea#message{display:block;margin:0 auto;width:92%;font-size:18px;padding:18px;border-radius:10px;resize:vertical;background-color:rgba(17,17,17,0.97);color:#fff;border:1px solid #333;text-align:left;font-family:'Share Tech Mono', monospace;box-shadow:inset 0 0 5px #111;transition: all 0.2s ease-in-out;}
.main-container textarea#message::placeholder{color:#fff;opacity:0.6;}
textarea#message:focus{outline:none;border-color:#fff;box-shadow:inset 0 0 15px #fff,0 0 25px #fff;transition:box-shadow 0.3s ease,border-color 0.3s ease;}

/* Action Button */
.actionButton{margin-top:15px;background:linear-gradient(145deg,#161616,#242424);color:#fff;border:2px solid #ccc;border-radius:10px;padding:15px 35px;font-weight:bold;font-family:'Orbitron',sans-serif;cursor:pointer;position:relative;overflow:hidden;text-shadow:0 0 2px #fff;box-shadow:0 0 6px #ffffff33,0 0 12px #ffffff11 inset;animation:ambientGlow 3.5s ease-in-out infinite alternate;transition:all 0.35s ease;}
@keyframes ambientGlow{0%{box-shadow:0 0 4px #ffffff33,0 0 8px #ffffff11 inset;}100%{box-shadow:0 0 12px #ffffff88,0 0 18px #ffffff33 inset;}}
.actionButton:hover{color:#000;background:linear-gradient(145deg,#f2f2f2,#dcdcdc);border-color:#fff;transform:translateY(-2px) scale(1.04);animation:hoverPulse 1.6s infinite alternate;box-shadow:0 0 10px #ffffffcc,0 0 20px #ffffff66 inset;}
@keyframes hoverPulse{0%{box-shadow:0 0 8px #ffffff88,0 0 15px #ffffff33 inset;}100%{box-shadow:0 0 16px #ffffffcc,0 0 25px #ffffff66 inset;}}

/* Contracts */
.contracts-wrapper{display:flex;justify-content:center;align-items:flex-start;gap:15px;flex-wrap:wrap;width:100%;}
.total-cost-container{width:630px;height:418px;background-size:contain;background-position:center;background-repeat:no-repeat;position:relative;border-radius:15px;box-shadow:0 4px 8px rgba(0,0,0,0.5);display:none;}
#leftContainer{background-image:url('https://raw.githubusercontent.com/OreStellar/Orestellar.github.io/refs/heads/main/images/Contract1.png');}
#totalCostContainer{background-image:url('https://raw.githubusercontent.com/OreStellar/Orestellar.github.io/refs/heads/main/images/Contract2.png');}

/* Summary Container */
.summary-container{
  display: none; /* Hidden by default */
  flex-direction: column;
  align-items: stretch;
  justify-content: flex-start;
  font-family: 'Share Tech Mono', monospace;
  font-size: 14px;
  line-height: 1.4;
  color: #00ff00;
  background: rgba(0,10,0,0.9);
  border: 2px solid #00ff00;
  border-radius: 12px;
  padding: 16px 20px;
  min-width: 400px;
  max-width: 500px;
  max-height: 420px;
  overflow-y: auto;
  overflow-x: hidden;
  box-shadow: 0 0 15px rgba(0,255,0,0.5), inset 0 0 10px rgba(0,255,0,0.3);
  backdrop-filter: blur(6px);
  animation: pulseGlow 2s infinite alternate;
}

@keyframes pulseGlow{0%{box-shadow:0 0 12px rgba(0,255,0,0.5), inset 0 0 6px rgba(0,255,0,0.3);}100%{box-shadow:0 0 20px rgba(0,255,0,0.7), inset 0 0 12px rgba(0,255,0,0.5);}}
.summary-container::-webkit-scrollbar{width:6px;}
.summary-container::-webkit-scrollbar-thumb{background:#00ff00;border-radius:4px;box-shadow:0 0 10px #00ff00;}

/* Summary table */
.summary-table th, .summary-table td {
  padding: 6px 10px;
  border-bottom: 1px solid rgba(0,255,0,0.15);
  font-size: 14px;
  white-space: nowrap;
  font-family: 'Share Tech Mono', monospace;
}

/* Column alignments */
.summary-table th:nth-child(1),
.summary-table td:nth-child(1) { /* Name column */
  text-align: right;
}

.summary-table td.price,
.summary-table td.quantity,
.summary-table td.total-column {
  text-align: left;  /* left-align numbers */
}
.summary-table td:first-child {
  text-align: right; /* right-align name */
}

/* Optional: headers neon effect */
.summary-table th {
  color: #00ff00;
  text-shadow: 0 0 6px #00ff00;
  border-bottom: 1px solid rgba(0,255,0,0.3);
}

/* Quote Header */
.quote-text {font-family: 'Orbitron', sans-serif;font-size:1.6rem;font-weight:700;color: #fff;text-align: center;text-shadow:0 0 8px #fff,0 0 16px #fff,0 0 24px #00ff00,0 0 32px #00ff00;animation: softGlow 2.5s infinite alternate;}
</style>
</head>
<body data-show-inventory="true">

<canvas id="starfield"></canvas>

<div class="container-wrapper">
  <header id="myHeader">
    <h1 id="logoText"><span id="ore">Ore</span><span id="stellar">Stellar</span></h1>
  </header>

<div class="main-container">
  <h3 class="quote-text">Paste Your Inventory Below</h3>
  <br>
  <textarea id="message" rows="8" placeholder="Compressed Ytirium 90143
Jet Ochre 13527
Magma Mercoxit 40599
Compressed Mordunium 592556
Bistot 1320"></textarea>
  <button id="submitButton" class="actionButton" disabled>Submit</button>
</div>

<div class="contracts-wrapper">
  <div id="leftContainer" class="total-cost-container"></div>
 <div id="summaryContainer" class="summary-container" style="display:none;"></div>
  <div id="totalCostContainer" class="total-cost-container">
    <div id="totalCostText">0 ISK</div>
  </div>
</div>

<button id="shareButton" class="actionButton" style="display:none;">Share Summary</button>
</div>

<script>
// ===== STARFIELD =====
const canvas=document.getElementById("starfield"),ctx=canvas.getContext("2d");
function resizeCanvas(){canvas.width=window.innerWidth;canvas.height=window.innerHeight;}
resizeCanvas();window.addEventListener("resize",()=>{resizeCanvas();createStars();});
let stars=[],clusterCount=12;
function createStars(){stars=[];const clusterCenters=[];for(let i=0;i<clusterCount;i++)clusterCenters.push({x:Math.random()*canvas.width,y:Math.random()*canvas.height});const totalStars=Math.floor(window.innerWidth*window.innerHeight/600);for(let i=0;i<totalStars;i++){let x,y;if(Math.random()<0.6){const c=clusterCenters[Math.floor(Math.random()*clusterCenters.length)];const radius=Math.random()*120;const angle=Math.random()*Math.PI*2;x=c.x+radius*Math.cos(angle);y=c.y+radius*Math.sin(angle);}else{x=Math.random()*canvas.width;y=Math.random()*canvas.height;}stars.push({x,y,size:Math.random()*1.5+0.2,color:["#ffffff","#ff99aa","#99ccff","#f0f0f0"][Math.floor(Math.random()*4)],speed:Math.random()*0.2+0.05,phase:Math.random()*Math.PI*2,twinkle:Math.random()<0.25,baseAlpha:0.8+Math.random()*0.2});}}
createStars();
let lastBrightTime=0,nextBrightInterval=7000+Math.random()*8000;
function drawStars(time=0){ctx.clearRect(0,0,canvas.width,canvas.height);if(time-lastBrightTime>nextBrightInterval){lastBrightTime=time;nextBrightInterval=7000+Math.random()*8000;for(let i=0;i<2;i++){const s=stars[Math.floor(Math.random()*stars.length)];s.isBright=true;s.brightStart=time;s.brightEnd=time+2000+Math.random()*1000;}}for(let s of stars){let alpha=s.baseAlpha;if(s.twinkle)alpha=0.55+0.25*Math.sin(time*0.002+s.phase);if(s.isBright&&time>=s.brightStart&&time<s.brightEnd)alpha=1;else s.isBright=false;ctx.beginPath();ctx.arc(s.x,s.y,s.size,0,Math.PI*2);ctx.fillStyle=s.color;ctx.globalAlpha=alpha;ctx.shadowBlur=alpha===1?s.size*8:s.size*4;ctx.shadowColor=s.color;ctx.fill();}ctx.globalAlpha=1;requestAnimationFrame(drawStars);}
drawStars();

// ===== FETCH PRICES =====
let priceList={};
async function fetchPrices(){
  const response = await fetch('https://raw.githubusercontent.com/OreStellar/Orestellar.github.io/main/data/prices.csv');
  const csvText = await response.text();
  const rows = csvText.split('\n');
  rows.forEach(row=>{
    const cols = row.split(',');
    if(cols.length>=2){
      const oreName = cols[0].toLowerCase().trim();
      const suggestedPrice = parseInt(cols[cols.length-2]);
      if(!isNaN(suggestedPrice)) priceList[oreName]=suggestedPrice;
    }
  });
}

// ===== HELPERS =====
function formatNumber(n){return n.toLocaleString();}
function makeTotalCopyable(el){if(!el)return;el.style.cursor='pointer';el.addEventListener('click',async()=>{await navigator.clipboard.writeText(el.innerText.replace(/[^0-9]/g,''));const original=el.innerText;el.innerText='Copied';setTimeout(()=>{el.innerText=original;},1500);});}
// ===== SHOW SUMMARY =====
function showContent(prefillText){
  const t = prefillText || document.getElementById('message').value;

  // Regex: match lines starting with letters, optional 'Compressed', then a number (quantity)
  const regex = /^([A-Za-z\s\.\-]+?)\s+([\d,]+)/gm;
  let match, summary=[], total=0;

  while ((match = regex.exec(t)) !== null) {
    let nameRaw = match[1].trim();

    // Remove trailing numbers / units like m3, ISK, etc.
    nameRaw = nameRaw.replace(/\d+([.,]\d+)?\s*(m3|ISK)?$/i, '').trim();

    const name = nameRaw.toLowerCase().replace(/\s+/g,' ');
    let qty = match[2].replace(/,/g,''); // remove commas
    qty = parseInt(qty);

    const displayName = nameRaw.replace(/^Compressed /i, "Comp. ");

    if (priceList[name] !== undefined) {
      summary.push({
        name: displayName,
        price: priceList[name],
        qty: qty,
        val: qty * priceList[name],
        unrecognized: false
      });
      total += qty * priceList[name];
    } else {
      summary.push({
        name: displayName,
        price: '-',
        qty: '-',
        val: 'Unrecognized',
        unrecognized: true
      });
    }
  }

  const summaryContainer = document.getElementById('summaryContainer');

  let tableHTML = '<table class="summary-table"><thead><tr><th>Name</th><th>Price</th><th>Quantity</th><th>Total</th></tr></thead><tbody>';

  summary.forEach(item => {
    tableHTML += `<tr class="${item.unrecognized ? 'unrecognized' : ''}">
      <td>${item.name}</td>
      <td class="price">${item.unrecognized ? item.price : formatNumber(item.price)}</td>
      <td class="quantity">${item.unrecognized ? item.qty : formatNumber(item.qty)}</td>
      <td class="total-column">${item.unrecognized ? item.val : formatNumber(item.val)}</td>
    </tr>`;
  });

  tableHTML += `<tr class="summary-total">
    <td colspan="3" style="text-align:left;">Total</td>
    <td id="summaryTotal">${formatNumber(total)}</td>
  </tr></tbody></table>`;

  summaryContainer.innerHTML = tableHTML;
  summaryContainer.style.display = 'flex';

  // Show or hide contracts based on whether prefillText is from shared URL
  const isSharedView = !!prefillText;
  document.getElementById('leftContainer').style.display = isSharedView ? 'none' : 'block';
  document.getElementById('totalCostContainer').style.display = isSharedView ? 'none' : 'block';
  document.getElementById('shareButton').style.display = isSharedView ? 'none' : 'inline-block';
  document.querySelector('.main-container').style.display = isSharedView ? 'none' : 'none';

  // Update contract total ISK if not shared view
  if (!isSharedView) {
    document.getElementById('totalCostText').innerText = formatNumber(total) + ' ISK';
    makeTotalCopyable(document.getElementById('totalCostText'));
  }

  // Make summary total copyable
  makeTotalCopyable(document.getElementById('summaryTotal'));

  // Attach sorting
  attachSorting(summaryContainer);
}



// ===== SORTING =====
function attachSorting(container){
  const table = container.querySelector('table');
  const headers = table.querySelectorAll('th');
  headers.forEach((header, index)=>{
    header.addEventListener('click', ()=>{
      const tbody = table.querySelector('tbody');
      const rows = Array.from(tbody.querySelectorAll('tr'));
      const ascending = !header.classList.contains('sorted-asc');
      headers.forEach(h=>h.classList.remove('sorted','sorted-asc','sorted-desc'));
      header.classList.add('sorted');
      header.classList.toggle('sorted-asc', ascending);
      header.classList.toggle('sorted-desc', !ascending);
      rows.sort((a,b)=>{
        if(a.classList.contains('summary-total')) return 1;
        if(b.classList.contains('summary-total')) return -1;
        const valA = a.children[index].innerText.replace(/[^0-9.]/g,'');
        const valB = b.children[index].innerText.replace(/[^0-9.]/g,'');
        if(index===0) return ascending ? a.children[index].innerText.localeCompare(b.children[index].innerText) : b.children[index].innerText.localeCompare(a.children[index].innerText);
        return ascending ? parseFloat(valA||0)-parseFloat(valB||0) : parseFloat(valB||0)-parseFloat(valA||0);
      });
      rows.forEach(r=>tbody.appendChild(r));
    });
  });
}

// ===== SUBMIT BUTTON =====
const submitBtn=document.getElementById('submitButton');
const messageBox=document.getElementById('message');
messageBox.addEventListener('input',()=>{submitBtn.disabled=messageBox.value.trim()==='';});
submitBtn.addEventListener('click',()=>{showContent();window.scrollTo({top:0,behavior:'smooth'});});

// ===== LOGO RESET =====
document.getElementById('myHeader').addEventListener('click', () => {
  window.location.href = window.location.origin + window.location.pathname;
});

// ===== LOGO ANIMATION =====
window.addEventListener('load',()=>{
  const ore=document.getElementById('ore');
  const stellar=document.getElementById('stellar');
  ore.style.animation='flickerRapid 0.3s linear forwards';
  setTimeout(()=>{ore.style.animation='softGlow 6s infinite';},300);
  setTimeout(()=>{stellar.style.animation='flickerRapid 0.3s linear forwards';setTimeout(()=>{stellar.style.animation='softGlow 6s infinite';},300);},400);
  setTimeout(()=>{ore.style.animation='flickerQuick 0.3s linear forwards';stellar.style.animation='flickerQuick 0.3s linear forwards';setTimeout(()=>{ore.style.animation='softGlow 6s infinite';stellar.style.animation='softGlow 6s infinite';},300);},1100);
});

// ===== SHARE BUTTON =====
document.getElementById('shareButton').addEventListener('click',()=>{
  const message = document.getElementById('message').value.trim();
  if(!message) return;
  const compressed = LZString.compressToEncodedURIComponent(message);
  const shareURL = `${window.location.origin}${window.location.pathname}?s=${compressed}`;
  navigator.clipboard.writeText(shareURL).then(()=>{
    const btn = document.getElementById('shareButton');
    const originalText = btn.innerText;
    btn.innerText = 'Copied';
    setTimeout(()=>{btn.innerText = originalText;},1500);
  });
});

// Auto-load summary if URL contains 's' parameter
window.addEventListener('load', () => {
  const params = new URLSearchParams(window.location.search);
  const compressed = params.get('s');
  if (compressed) {
    const inventoryText = LZString.decompressFromEncodedURIComponent(compressed);
    if (inventoryText) {
      showContent(inventoryText);

      // Hide everything except the summary container
      document.querySelector('.main-container').style.display = 'none';
      document.getElementById('leftContainer').style.display = 'none';
      document.getElementById('totalCostContainer').style.display = 'none';
      document.getElementById('shareButton').style.display = 'none';

      // Ensure summary container uses ledger-style font
      const summaryContainer = document.getElementById('summaryContainer');
      summaryContainer.style.fontFamily = "'Share Tech Mono', monospace";
      summaryContainer.style.fontSize = "14px";
      summaryContainer.style.lineHeight = "1.4";
    }
  }
});


// ===== FETCH PRICES INIT =====
fetchPrices();
</script>
</body>
</html>
