<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OreStellar</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Chivo+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>

/* ----------------- Scrollbars ----------------- */
/* WebKit browsers (Chrome, Edge, Safari) */
#ratesContainer::-webkit-scrollbar {
    width: 8px;              /* scrollbar width */
    background: transparent;  /* make the scrollbar track transparent */
}
#ratesContainer::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.2); /* faint thumb */
    border-radius: 4px;
}
#ratesContainer::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.4); /* brighter on hover */
}

/* Firefox */
#ratesContainer {
    scrollbar-width: thin;       
    scrollbar-color: rgba(255,255,255,0.2) transparent;
}

/* ----------------- Body & Global ----------------- */
body {
    margin: 0;
    padding: 0;
    font-family: 'Orbitron', sans-serif;
    background-color: #000;
    color: #fff;
    overflow-x: hidden;
}

/* ----------------- Neon / Glow ----------------- */
.neon {
    color: #ffffff;
    text-shadow:
        0 0 5px #6e6e6e,
        0 0 10px #d1d1d1,
        0 0 20px #dadada,
        0 0 40px rgb(245, 245, 245),
        0 0 80px rgba(255, 255, 255, 0.603);
}

/* ----------------- Starfield layers ----------------- */
#oreStellarlogo {
    position: relative;
    z-index: 5;
}
#staticStars,
#starfield {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
}
#staticStars { z-index: -2; opacity: 0.4; }
#starfield { z-index: -1; }

/* ----------------- Overlay ----------------- */
#overlay {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 10;
}
#overlay.active {
    display: block;
    opacity: 1;
    visibility: visible;
}

/* ----------------- Modals ----------------- */
.modal {
    display: none;
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background: #111;
    padding: 1rem;
    z-index: 11;
}
.modal.active { display: block; }

/* ----------------- Logo ----------------- */
#logo {
    text-align: center;
    font-size: 4rem;
    margin: 110px 0;
    transform: skewX(-10deg);
}

/* ----------------- Containers ----------------- */
#contractsContainer {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 20px;
    width: 100%;
    max-width: 1200px;
    margin: 40px auto;
    flex-wrap: nowrap;
    box-sizing: border-box;
}

#inventoryContainer {
    width: 80%;
    max-width: 500px;
    margin: 40px auto;
    padding: 20px;
    background: rgba(17,17,17,0.623);
    border: 1px solid rgba(0,0,0,0.411);
    border-radius: 12px;
    position: relative;
    box-sizing: border-box;
    overflow: hidden;
}
#inventoryContainer textarea {
    width: 100%;
    height: 150px;
    background: rgba(22,22,22,0.644);
    border: 1px solid #000;
    border-radius: 8px;
    color: #fff;
    font-family: 'Chivo Mono', monospace;
    font-size: 1rem;
    padding: 10px;
    resize: vertical;
    box-sizing: border-box;
}

    #ratesContainer {
    display: none;
    position: fixed;  /* important so z-index applies correctly */
    top: 50%;
    left: 50%;
    width: 94%;
    height: 94%;
    transform: translate(-50%, -50%);
    background: #00000096;
    padding: 20px;
    border-radius: 12px;
    z-index: 11;  /* <-- must be higher than overlay (10) */
    box-sizing: border-box
}

#summaryContainer {
    font-family: 'Chivo Mono', monospace;
    width: 80%;
    min-width: 620px;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.3);
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 0 15px rgba(255,255,255,0.2);
    gap: 5px; /* space between columns */
    text-align: center;
    overflow-x: auto;
    overflow-y: visible;
    position: relative;
}

#summaryContainer th, 
#summaryContainer td {
    padding: 8px 12px;
    text-align: left;
    overflow: hidden;         /* Prevent text from spilling */
    text-overflow: ellipsis;  /* Shows "..." if text is too long */
    white-space: nowrap;      /* Prevent wrapping */
}

/* Make all columns except the last stretch evenly */
#summaryContainer th:not(:last-child),
#summaryContainer td:not(:last-child) {
    width: auto;              /* Evenly divide space */
}

/* Ensure last column (Total) keeps its size and doesn't wrap */
#summaryContainer th:last-child,
#summaryContainer td:last-child {
    white-space: nowrap;
    text-align: right;        /* Align numbers nicely */
}
#contractRight {
    display: none;
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%) scale(0.8);
    background: #111;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s ease;
    z-index: 11;
    max-width: 90%;
    max-height: 90%;
    overflow-y: auto;
}
#contractRight.active {
    display: block;
    opacity: 1;
    visibility: visible;
    transform: translate(-50%, -50%) scale(1);
}

#contractRightLogo { display: none; cursor: pointer; }

/* ----------------- Buttons ----------------- */
#submitButton {
    padding: 12px 30px;
    background: none;
    border: 2px solid rgb(65,65,65);
    border-radius: 10px;
    color: #fff;
    font-size: 1.2rem;
    cursor: pointer;
    transition: all 0.3s;
    text-shadow: 0 0 5px #fff, 0 0 10px #fff;
}
#submitButton:hover {
    background: rgba(0,0,0,0.5);
    box-shadow: 0 0 20px #fff, 0 0 40px #fff;
}

#buttonContainer {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-top: 20px;
}

/* ----------------- Contract Boxes ----------------- */
.contract-container {
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0,0,0,0.9);
    color: #fff;
    padding: 20px;
    border-radius: 15px;
    z-index: 20;
    min-width: 300px;
    max-width: 400px;
    box-shadow: 0 0 20px #fff;
}

.contract-container,
.contract-table th,
.contract-table td {
    font-family: 'Chivo Mono', monospace;
}

.contract-table {
    width: 100%;
    border-collapse: collapse;
}
.contract-table th, .contract-table td {
    text-align: left;
    white-space: nowrap;
    padding: 6px 4px;
}
.contract-table th { font-weight: 600; }

.glow-bullet {
    color: rgba(72, 255, 0, 0.473);
    margin-left: 3px;
    width: 1ch;
    text-align: center;
}

/* ----------------- Side Tabs ----------------- */
#sideTabsContainer {
    position: fixed;
    top: 10%;
    right: 0;
    display: flex;
    flex-direction: column;
    gap: 15px;
    z-index: 11;
}
.sideTab {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: flex-start;
    width: 250px;
    height: 30px;
    background: linear-gradient(145deg, rgba(0,255,255,0.05), rgba(0,255,255,0.1));
    border: 2px solid rgba(0,0,0,0.5);
    border-left: none;
    border-radius: 25px;
    color: #fff;
    cursor: pointer;
    text-shadow: 0 0 5px #fff, 0 0 10px #fff;
    box-shadow: 0 0 10px #fff;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    gap: 10px;
}
.sideTab:hover { transform: translateX(-20px); box-shadow: 0 0 20px #fff, 0 0 40px #fff; }
.sideTab:active { transform: translateX(22px) scale(0.98); box-shadow: 0 0 20px #fff, 0 0 40px #fff; }

#ratesTab svg {
  margin-left: 35px; /* adds space after the icon */
  vertical-align: middle;
}

#ratesTab {
  left: 95px;
}

#compareTab svg {
  margin-left: 15x; /* adds space after the icon */
  vertical-align: middle;
}
#compareTab {
  left: 95px;
}
</style>
</head>
<body>

<canvas id="staticStars"></canvas>
<canvas id="starfield"></canvas>
<div id="overlay" style="display:none;"></div>
<div id="logo" class="neon">OreStellar</div>
<div id="inventoryContainer">

  <p class="PasteText">Paste Your Inventory Below</p>

  <textarea id="messageBox" placeholder="Enter your ores here..."></textarea>
  <div id="buttonContainer">
    <button id="submitButton">Submit</button>
  </div>

</div>
  <div id="sideTabsContainer">
<!-- Side Tabs with Icons -->
<div id="ratesTab" class="sideTab">
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="cyan" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M3 5h.01"/>
    <path d="M3 12h.01"/>
    <path d="M3 19h.01"/>
    <path d="M8 5h13"/>
    <path d="M8 12h13"/>
    <path d="M8 19h13"/>
  </svg>
  <span>Rates</span>
</div>


<!-- Compare tab with scale icon -->
<div id="compareTab" class="sideTab">
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="lime" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="m16 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/>
    <path d="m2 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/>
    <path d="M7 21h10"/>
    <path d="M12 3v18"/>
    <path d="M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2"/>
  </svg>
</div>
</div>
<div id="contractsContainer">

  <div id="summaryContainer" style="display: none;"></div>

<!-- SVG Logo -->
<div id="contractRightLogo" class="open-modal" data-modal="contractRight" style="cursor:pointer;">
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sticky-note-icon lucide-sticky-note">
    <path d="M16 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V8Z"/>
    <path d="M15 3v4a2 2 0 0 0 2 2h4"/>
  </svg>
    <span>Compare</span>
</div>

<!-- Modal -->
<div id="contractRight" class="contract-container modal">

  <table class="contract-table">
    <tr>
      <th>Contract Type<span class="glow-bullet">‚Ä¢</span></th>
      <td>Item Exchange</td>
    </tr>
    <tr>
      <th>Availability<span class="glow-bullet">‚Ä¢</span></th><td>Private</td>
    </tr>
    <tr>
      <th>Name<span class="glow-bullet">‚Ä¢</span></th>
      <td>OreStellar</td>
    </tr>
    <tr>
      <th>I will pay<span class="glow-bullet">‚Ä¢</span></th>
      <td>0</td>
    </tr>
    <tr>
      <th>I will receive<span class="glow-bullet">‚Ä¢</span></th>
      <td id="contract-right-receive">0</td>
    </tr>
    <tr>
      <th>Expiration<span class="glow-bullet">‚Ä¢</span></th>
      <td>1 week</td>
    </tr>
    <tr>
      <th>Description<span class="glow-bullet">‚Ä¢</span></th>
      <td>That was Stellar!</td>
    </tr>
  </table>
</div>
</div>
<div id="ratesContainer" class="open-modal" style="display:none;">
  <button id="ratesClose">‚úï</button>
  <input type="text" id="searchInput" placeholder="WHAT GOES HERE">
  <div id="ratesGrid"></div>
</div>

<div id="compareContainer" class="open-modal" style="display:none;">
  <!-- Compare content here -->
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- DOM Elements ---
    const submitButton = document.getElementById('submitButton');
    const messageBox = document.getElementById('messageBox');
    const summaryContainer = document.getElementById('summaryContainer');
    const inventoryContainer = document.getElementById('inventoryContainer');
    const logo = document.getElementById('logo');

    const contractRight = document.getElementById('contractRight');
    const contractRightLogo = document.getElementById('contractRightLogo');
    const overlay = document.getElementById('overlay');

    const ratesTab = document.getElementById('ratesTab');
    const compareTab = document.getElementById('compareTab');
    const ratesContainer = document.getElementById('ratesContainer');
    const compareContainer = document.getElementById('compareContainer');

    let openPanel = null; // currently open panel
    let previousVisibleSections = [];
    let previousPanels = [];

    overlay.addEventListener('click', (event) => {
    if (event.target === overlay) { // only close if clicking directly on overlay
        console.log('üí° Overlay click detected, closing panel');
        showPanel(null);
    }
});

// -------------------------
// Overlay + Document Click
// -------------------------
function setupClosePanelHandlers() {
    // Click on overlay should close the open panel
    overlay.addEventListener('click', (e) => {
        // Only if overlay itself was clicked
        if (e.target === overlay && openPanel) {
            console.log('üü† Overlay click: closing', openPanel.id);
            showPanel(null);
        }
    });

    // Click anywhere else in the document
    document.addEventListener('click', (e) => {
        if (!openPanel) return; // nothing is open, do nothing

        // Check if click is outside the currently open panel and its corresponding tab
        const isRates = openPanel === ratesContainer;
        const isCompare = openPanel === compareContainer;
        const isContract = openPanel === contractRight;

        const tabCheck = (isRates && ratesTab.contains(e.target)) ||
                         (isCompare && compareTab.contains(e.target)) ||
                         (isContract && contractRightLogo.contains(e.target));

        if (!openPanel.contains(e.target) && !tabCheck) {
            console.log('üí• Document click outside panel: closing', openPanel.id);
            showPanel(null);
        }
    });
}

// Call it after DOMContentLoaded
setupClosePanelHandlers();
    
// -------------------------
// Main showPanel function
// -------------------------
function showPanel(panel) {
    console.log('üü¢ showPanel called with:', panel, 'current openPanel:', openPanel?.id);

    // If clicking the same panel that's already open, do nothing (or just keep it open)
    if (openPanel === panel) {
        console.log('‚ö™ Panel already open, doing nothing:', panel.id);
        return; //function showPanel(panel) {
    console.log('üü¢ showPanel called with:', panel, 'current openPanel:', openPanel?.id);

    // If clicking the same panel, toggle it closed
    if (openPanel === panel) {
        console.log('üî¥ Closing currently open panel:', openPanel.id);
        panel.style.display = 'none';
        openPanel = null;

        // Restore previously visible panels + logo
        previousPanels.forEach(p => p.style.display = 'block');
        previousPanels = [];

        overlay.style.display = 'none';
        return;
    }

    // Hide currently open panel if different
    if (openPanel) {
        openPanel.style.display = 'none';
    }

    // Hide all other panels + OreStellar logo
    previousPanels = [];
    [contractRight, summaryContainer, compareContainer, ratesContainer, oreStellarLogo].forEach(p => {
        if (p && p !== panel && p.style.display !== 'none') {
            previousPanels.push(p);
            p.style.display = 'none';
        }
    });

    // Open the new panel
    if (panel) {
        panel.style.display = 'block';
        openPanel = panel;
        overlay.style.display = 'block';
    

    }}
    // --- Rates Grid ---
    function showRatesGrid() {
        ratesContainer.innerHTML = ''; // clear previous

        const searchInput = document.createElement('input');
        searchInput.placeholder = "Begin typing to search orelist..";
        searchInput.style.width = "55%";
        searchInput.style.marginBottom = "10px";
        searchInput.style.padding = "5px";
        searchInput.style.borderRadius = "6px";
        searchInput.style.border = "1px solid rgba(255,255,255,0.2)";
        searchInput.style.background = "rgba(0,0,0,0.3)";
        searchInput.style.color = "#fff";
        searchInput.style.fontFamily = "'Chivo Mono', monospace";
        ratesContainer.appendChild(searchInput);

        const grid = document.createElement('div');
        grid.className = 'grid';
        ratesContainer.appendChild(grid);

        Object.keys(priceData).forEach((ore, index) => {
            if (ore.toLowerCase().startsWith('compressed ')) return;

            const entry = priceData[ore];
            const cell = document.createElement('div');
            cell.className = 'grid-item neon';
            cell.style.opacity = 0;
            cell.innerHTML = `
                <strong>${ore}</strong>
                <span>${entry.price.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</span>
            `;
            grid.appendChild(cell);

            setTimeout(() => {
                cell.style.transition = "opacity 0.4s ease, transform 0.3s ease, box-shadow 0.3s ease";
                cell.style.opacity = 1;
                cell.style.transform = "translateY(0)";
            }, index * 20);
        });
            // Search & highlight/dim functionality
        searchInput.addEventListener('input', () => {
        const filter = searchInput.value.toLowerCase();
        document.querySelectorAll('#ratesContainer .grid-item').forEach(item => {
            const text = item.textContent.toLowerCase();
            if (text.includes(filter)) {
                item.style.opacity = '1';
                item.style.boxShadow = '0 0 15px #fff, 0 0 30px #fff';
            } else {
                item.style.opacity = '0.3';
                item.style.boxShadow = '0 0 5px #C4C4C4, 0 0 10px #C4C4C4';
            }
        });
    });
// Only create once
if (!document.getElementById('ratesClose')) {
    const closeBtn = document.createElement('div');
    closeBtn.id = 'ratesClose';
    closeBtn.innerHTML = '‚úï';
    closeBtn.style.position = 'absolute';
    closeBtn.style.top = '-3px';
    closeBtn.style.right = '10px';
    closeBtn.style.cursor = 'pointer';
    closeBtn.style.fontSize = '1.2rem';
    closeBtn.style.color = 'rgba(255,255,255,0.8)';
    closeBtn.style.transition = 'color 0.2s';
    closeBtn.onmouseover = () => closeBtn.style.color = '#fff';
    closeBtn.onmouseout = () => closeBtn.style.color = 'rgba(255,255,255,0.8)';

    ratesContainer.appendChild(closeBtn);

    // Attach handler to close ratesContainer
    closeBtn.addEventListener('click', () => {
        showPanel(null); // close ratesContainer and restore previous
    });
}


    }

// --- Tab Clicks ---
ratesTab.addEventListener('click', (e) => {
    e.stopPropagation(); // prevent document click from firing
    console.log('üìå Rates tab clicked');

    showPanel(ratesContainer); // this now handles saving/restoring previous panels
    showRatesGrid();           // keep your grid function call
});

compareTab.addEventListener('click', (e) => {
    e.stopPropagation();
    console.log('üìå Compare tab clicked');

    showPanel(compareContainer); // restores previous panels automatically
});


    // --- Modal Clicks ---
    contractRightLogo.addEventListener('click', (e) => {
        e.stopPropagation();
        showPanel(contractRight);
    });

document.addEventListener('click', (e) => {
    console.log('üìå Document click target:', e.target, 'openPanel:', openPanel?.id);
    if (!openPanel || overlay.contains(e.target)) return;

    if (
        (openPanel === ratesContainer && !ratesContainer.contains(e.target) && !ratesTab.contains(e.target)) ||
        (openPanel === compareContainer && !compareContainer.contains(e.target) && !compareTab.contains(e.target)) ||
        (openPanel === contractRight && !contractRight.contains(e.target) && !contractRightLogo.contains(e.target))
    ) {
        console.log('üí• Closing panel due to outside click:', openPanel.id);
        showPanel(null);
    }
});



// --- Submit Button ---
document.getElementById('submitButton').addEventListener('click', () => {
    console.log("=== Submit Button Clicked ===");

    const input = document.getElementById('messageBox').value.trim();
    console.log("Input text:", input);
    if (!input) {
        console.log("No input provided. Exiting.");
        return;
    }
    const summary = document.getElementById('summaryContainer');
    const parsed = parseInventoryText(input);

    console.log("Hiding inventory, showing contracts and summary showing contractbutton");
    inventoryContainer.style.display = 'none';
    summary.style.display = 'block';
    contractRightLogo.style.display = 'inline-block';

    console.log("Clearing previous summary table");
    summary.innerHTML = '';

    const parsedLines = parseInventoryText(input);
    console.log("Parsed inventory lines:", parsedLines);

    // Build table and tbody
    const table = document.createElement('table');
    table.classList.add('summary-table');

    const thead = document.createElement('thead');
    thead.innerHTML = `<tr>
        <th>Ore</th>
        <th>Quantity</th>
        <th>Unit Price</th>
        <th>Compressed</th>
        <th>Total</th>
    </tr>`;
    table.appendChild(thead);

    const tbody = document.createElement('tbody');
    table.appendChild(tbody);
    summary.appendChild(table);

    let grandTotal = 0;
    let delay = 0;
    const animationDelay = 200;

    console.log("Creating rows for each ore...");
    const rows = parsedLines.map(item => {
        const displayName = item.ore.replace(/^Compressed\s+/i, '');
        const isCompressed = item.ore.toLowerCase().startsWith('compressed ') ? '‚úÖ' : '‚ùå';
        const unitPrice = priceData[item.ore]?.price || 0;
        const total = item.quantity * unitPrice;
        grandTotal += total;

        const row = document.createElement('tr');
        row.innerHTML = `
            <td style="text-align:center;">${displayName}</td>
            <td style="text-align:right;">0</td>
            <td style="text-align:right;">0.00</td>
            <td style="text-align:center;">${isCompressed}</td> 
            <td style="text-align:right;">0.00</td>              
        `;
        tbody.appendChild(row);

        //right contract receives grand total amount
        document.getElementById('contract-right-receive').textContent = grandTotal.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });

        console.log("Row created:", row.innerHTML);
        console.log("Cells in row:", row.cells.length);

        return { row, quantity: item.quantity, unitPrice, total };
    });

    console.log("Animating rows...");
    rows.forEach(({ row, quantity, unitPrice, total }, index) => {
        const qtyCell = row.cells[1];
        const priceCell = row.cells[2];
        const totalCell = row.cells[4];

        console.log(`Animating row ${index}: ${row.cells[0].textContent}`);
        console.log("Qty cell:", qtyCell, "Price cell:", priceCell, "Total cell:", totalCell);
        totalCell.style.color = "#00ff00"; // bright green
        setTimeout(() => {
            animateValue(qtyCell, 0, quantity, 500);
            animateValue(priceCell, 0, unitPrice, 500, true);
            animateValue(totalCell, 0, total, 500, true);
            row.style.animation = `fadeInRow 0.4s ease forwards`;
        }, delay);

        delay += animationDelay;
    });

    console.log("Adding Grand Total row");
    const totalRow = document.createElement('tr');
    totalRow.innerHTML = `
    <td colspan="4" style="text-align:right;font-weight:bold;">Grand Total</td>
    <td style="text-align:right;font-weight:bold;">0.00</td>
`;
tbody.appendChild(totalRow);

// Grab the actual cell containing the number (0.00)
// It is the second <td>, so index = 1
const grandCell = totalRow.cells[1];
grandCell.style.color = "#00ff00"; // bright green
console.log("Animating Grand Total cell:", grandCell); // debugging
setTimeout(() => {
    animateValue(grandCell, 0, grandTotal, 800, true);
}, delay + 200);
// --- Debug container positions ---
function debugContainers() {
    const containers = [
        { name: 'Summary', el: summary },
        { name: 'Compare', el: compareContainer }
    ];

    containers.forEach(c => {
        // Temporarily make visible if hidden
        const wasHidden = c.el.style.display === 'none';
        if (wasHidden) {
            c.el.style.display = 'block';
            c.el.style.position = 'absolute';
            c.el.style.visibility = 'hidden';
        }

        const rect = c.el.getBoundingClientRect();
        console.log(`${c.name} container rect:`, rect);

        // Restore previous state
        if (wasHidden) {
            c.el.style.display = 'none';
            c.el.style.visibility = 'visible';
            c.el.style.position = '';
        }
    });
}

// Call the debug function
debugContainers();


    console.log("=== Submit Button Finished Setup ===");
});


// Helper function for counting animation
function animateValue(cell, start, end, duration, isFloat = false) {
    const range = end - start;
    let startTime = null;

    function step(timestamp) {
        if (!startTime) startTime = timestamp;
        const progress = Math.min((timestamp - startTime) / duration, 1);
        const value = start + range * progress;
        cell.textContent = isFloat
            ? value.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })
            : Math.round(value).toLocaleString();
        if (progress < 1) requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
}

/* --- Static Background Stars --- */
const staticCanvas = document.getElementById('staticStars');
const sctx = staticCanvas.getContext('2d');

function resizeStatic() {
  staticCanvas.width = window.innerWidth;
  staticCanvas.height = window.innerHeight;
  drawStaticStars();
}
window.addEventListener('resize', resizeStatic);

function drawStaticStars() {
  sctx.clearRect(0, 0, staticCanvas.width, staticCanvas.height);
  const totalStaticStars = 3200;

  for (let i = 0; i < totalStaticStars; i++) {
    const x = Math.random() * staticCanvas.width;
    const y = Math.random() * staticCanvas.height;

    // small, visible stars
    let size = 0.5 + Math.random() * 0.8;
    let alpha = 0.3 + Math.random() * 0.7;
    let color = '255,255,255';

    const roll = Math.random();
    if (roll < 0.008) color = '255,180,180';  // pink
    else if (roll < 0.015) color = '255,80,80'; // red
    else if (roll < 0.02) color = '255,255,180'; // yellow

    sctx.fillStyle = `rgba(${color},${alpha})`;
    sctx.fillRect(x, y, size, size);
  }
}
resizeStatic();

/* --- Animated Flickering Stars --- */
/* --- Animated Flickering Stars --- */
const canvas = document.getElementById('starfield');
const ctx = canvas.getContext('2d');

let stars = [];
const totalStars = 300;           // total animated stars
const twinkleChance = 0.05;       // only 5% twinkle

function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  generateStars();
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

function generateStars() {
  stars.length = 0;

  for (let i = 0; i < totalStars; i++) {
    // Cluster logic
    let x, y;
    if (Math.random() < 0.8) { // 30% stars in clusters
      const cx = (Math.random() * 0.8 + 0.1) * canvas.width;
      const cy = (Math.random() * 0.8 + 0.1) * canvas.height;
      x = cx + (Math.random() - 0.5) * 150;
      y = cy + (Math.random() - 0.5) * 150;
    } else {
      x = Math.random() * canvas.width;
      y = Math.random() * canvas.height;
    }

    // Determine color (<2% chance for colored)
    const roll = Math.random();
    let color = '255,255,255'; // default white
    if (roll < 0.006) color = '255,180,180';    // light pink
    else if (roll < 0.012) color = '255,80,80'; // red
    else if (roll < 0.018) color = '255,255,180'; // yellow

    // Small radius
    const r = 0.5 + Math.random() * 1.5;

    stars.push({
      x,
      y,
      r,
      color: `rgb(${color})`,
      twinkle: Math.random() < twinkleChance,
      flickerOffset: Math.random() * Math.PI * 2,
      flickerSpeed: 0.005 + Math.random() * 0.04, // slow
      flickerIntensity: 0.05 + Math.random() * 0.05
    });
  }
}

function drawStars() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  for (const s of stars) {
    let alpha = 1;
    if (s.twinkle) {
      alpha = 0.7 + s.flickerIntensity * Math.sin(Date.now() * 0.005 + s.flickerOffset);
    }

    ctx.beginPath();
    ctx.fillStyle = s.color;
    ctx.globalAlpha = alpha;
    ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
    ctx.fill();
  }

  ctx.globalAlpha = 1;
  requestAnimationFrame(drawStars);
}

drawStars();


// --- CSV Parsing & Price Data ---
let priceData = {};
let recognizedOres = [];
let csvLoaded = false;

const csvUrl = 'https://raw.githubusercontent.com/OreStellar/Orestellar.github.io/main/data/prices.csv';

// Helper to split CSV lines properly (handles quotes and commas)
function parseCSVLine(line) {
    const regex = /(".*?"|[^",]+)(?=\s*,|\s*$)/g;
    const match = line.match(regex);
    if (!match) return [];
    return match.map(c => c.replace(/^"|"$/g, '').trim());
}

// Fetch CSV and populate priceData
fetch(csvUrl)
  .then(res => res.text())
  .then(text => {
    const lines = text.trim().split('\n');
    const headers = parseCSVLine(lines[0]);
    const colPrice = headers.findIndex(h => h.trim() === "Suggested Buy Price @ 150%");

    if (colPrice === -1) {
        console.error('‚ùå Could not find "Suggested Buy Price @ 150%" column in CSV!');
        return;
    }

    priceData = {}; // clear previous data

    // rows 2‚Äì191
    const oreLines = lines.slice(1, 191);
    oreLines.forEach(line => {
        const cols = parseCSVLine(line);
        const oreVariant = cols[0];
        if (!oreVariant || !cols[colPrice]) return;

        const price = parseFloat(cols[colPrice].replace(/,/g, '')) || 0;
        priceData[oreVariant] = { price };
    
    });

    recognizedOres = Object.keys(priceData).sort((a, b) => b.length - a.length);
    csvLoaded = true;

    console.log('‚úÖ CSV loaded', recognizedOres.length, 'ores');
    console.log('Full priceData:', priceData);
  })
  .catch(err => console.error('Error loading CSV:', err));


// --- Parse one line of inventory text ---
function parseOreLine(line) {
    line = line.trim();
    if (!line) return null;

    const sortedOres = Object.keys(priceData).sort((a,b) => b.length - a.length);
    let matchedOre = null;

    for (const oreName of sortedOres) {
        if (line.toLowerCase().includes(oreName.toLowerCase())) {
            matchedOre = oreName;
            break; // longest match first
        }
    }

    if (!matchedOre) return null;

    const qtyMatch = line.match(/([\d,]+)/);
    const quantity = qtyMatch ? parseInt(qtyMatch[1].replace(/,/g,''), 10) : 1;

    return { ore: matchedOre, quantity };
}


// --- Parse full inventory text ---
function parseInventoryText(text) {
    const lines = text.split('\n').map(l => l.trim()).filter(Boolean);
    const result = [];

    const sortedOres = Object.keys(priceData).sort((a, b) => b.length - a.length);

    for (const line of lines) {
        let matchedOre = null;
        for (const oreName of sortedOres) {
            if (line.toLowerCase().includes(oreName.toLowerCase())) {
                matchedOre = oreName;
                break;
            }
        }

        if (!matchedOre) continue;

        const qtyMatch = line.match(/([\d,]+)/);
        const quantity = qtyMatch ? parseInt(qtyMatch[1].replace(/,/g, ''), 10) : 1;

        result.push({ ore: matchedOre, quantity });
    }

    return result;
}


// --- Animate numeric values ---
function animateValue(cell, start, end, duration = 500, isFloat = false) {
    const startTime = performance.now();

    function step(currentTime) {
        const progress = Math.min((currentTime - startTime) / duration, 1);
        const value = start + (end - start) * progress;

        cell.textContent = isFloat
            ? value.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})
            : Math.round(value).toLocaleString();

        if (progress < 1) requestAnimationFrame(step);
    }

    requestAnimationFrame(step);
}

// --- Hide all panels ---
function hidePanels() {
  overlay.classList.remove('visible');
  [ratesContainer, compareContainer].forEach(el => el.classList.remove('active'));

  setTimeout(() => {
    [ratesContainer, compareContainer].forEach(el => (el.style.display = 'none'));
  }, 400); // match CSS transition
}


ratesTab.addEventListener('click', () => {
   console.log("Rates tab clicked");
    // Hide other panels and show rates
    showPanel(ratesContainer, ratesTab); 

    // Optional: populate the rates grid
    showRatesGrid();
});

compareTab.addEventListener('click', e => {
   console.log("Rates tab clicked");
  e.stopPropagation();
  showPanel(compareContainer, compareTab);
});

document.addEventListener('click', e => {
    console.log('üí• Document click:', e.target, 'openPanel:', openPanel?.id);

    if (overlay.contains(e.target)) {
        console.log('üí° Click on overlay ignored');
        return; // don't close panel when clicking overlay
    }

    if (
        (openPanel === ratesContainer && !ratesContainer.contains(e.target) && !ratesTab.contains(e.target)) ||
        (openPanel === compareContainer && !compareContainer.contains(e.target) && !compareTab.contains(e.target)) ||
        (openPanel === contractRight && !contractRight.contains(e.target) && !contractRightLogo.contains(e.target))
    ) {
        console.log('üí• Closing panel due to outside click:', openPanel.id);
        showPanel(null);
    }
});



// --- CSS injection for grid dynamically injects a <style> tag into your page‚Äôs <head> with all the CSS needed for your rates grid layout.

const style = document.createElement('style');
style.innerHTML = `

#ratesContainer .grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
  gap: 8px;
}
#ratesContainer .grid-item {
    display: flex;
    flex-direction: column;       /* stack vertically */
    justify-content: space-between; /* pushes first item up, last item down */
    background: rgba(0,255,255,0.05);
    padding: 8px;
    border-radius: 6px;
    text-align: center;
    font-size: 0.85rem;
    box-shadow: 0 0 10px #fff, 0 0 20px #fff;
    transform: translateY(10px);
    transition: transform 0.2s, box-shadow 0.3s;
  height: 60px; /* or whatever is half of the current height */
  width: 90;
}
}

#ratesContainer .grid-item:hover {
  transform: scale(1.05);
}
`;
document.head.appendChild(style);


// --- Call it after CSV is loaded ---
if (csvLoaded) showRatesGrid();
else {
    const checkCsv = setInterval(() => {
        if (csvLoaded) {
            showRatesGrid();
            clearInterval(checkCsv);
        }
    }, 100);
}




// Dynamically update "I will receive" value
function updateGrandTotal(value) {
  document.getElementById('grandTotalCell').textContent = value.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}



}});

</script>
</div>
</body>
</html>
