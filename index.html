<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>OreStellar</title>

<!-- Google Font: Orbitron -->
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet">

<!--
  FULL expanded stylesheet â€” verbose for clarity and parity with your original long file.
  - Keeps neon/ledger aesthetic
  - Caps summary width so it doesn't stretch
  - Contracts sit inline with summary container
-->
<style>
  /* ---------------- BASE ---------------- */
  html,body{
    margin:0;
    padding:0;
    height:100%;
    overflow:hidden;
    background:black;
    font-family: 'Orbitron', monospace;
    color: white;
  }

  /* ---------------- STARFIELD canvas (restored original style) ---------------- */
  canvas#starfield {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 0;
    pointer-events: none;
  }

  /* ---------------- PAGE WRAPPER ---------------- */
  .container-wrapper {
    position: relative;
    z-index: 2;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    min-height:100vh;
    gap:20px;
    padding:20px;
    box-sizing:border-box;
  }

  /* ---------------- HEADER / LOGO ---------------- */
  #myHeader{
    display:flex;
    justify-content:center;
    align-items:center;
    flex-direction:column;
    text-align:center;
    width:100%;
    max-width:650px;
    margin-bottom:40px;
    cursor:pointer;
    z-index:2;
  }

  #logoText{
    display:inline;
    font-family:'Orbitron',sans-serif;
    font-weight:700;
    font-size:5rem;
    letter-spacing:0;
    color: rgba(255,255,255,0.1);
    transform: skewX(-8deg);
  }

  #logoText span{ display:inline; color: rgba(255,255,255,0.1); text-shadow:none; }

  @keyframes softGlow{
    0%,100%{ text-shadow:0 0 5px #fff; color: rgba(255,255,255,0.75); }
    50%   { text-shadow:0 0 15px #fff; color: rgba(255,255,255,1); }
  }
  @keyframes flickerRapid{
    0%,20%,40%,60%,80%,100% { color: rgba(255,255,255,1); text-shadow:0 0 10px #fff; }
    10%,30%,50%,70%,90% { color: rgba(255,255,255,0.1); text-shadow:none; }
  }
  @keyframes flickerQuick{
    0%,50%,100% { color: rgba(255,255,255,0.1); text-shadow:none; }
    25%,75% { color: rgba(255,255,255,1); text-shadow:0 0 10px #fff; }
  }

  /* ---------------- MAIN CARD ---------------- */
  .main-container{
    width:650px;
    max-width:90%;
    padding:25px;
    display:flex;
    flex-direction:column;
    justify-content:center;
    align-items:center;
    background-color: rgba(20,20,20,0.92);
    border-radius:15px;
    box-sizing:border-box;
    z-index:2;
  }

  .quote-text{
    font-style:italic;
    font-weight:bold;
    font-size:21px;
    animation: glowPulse 3s infinite;
    margin:0;
  }
  @keyframes glowPulse{
    0%,100%{ text-shadow:0 0 5px #b3b4b4, 0 0 10px #d5e2e1; }
    50%   { text-shadow:0 0 15px #fff, 0 0 20px #aaa; }
  }

  textarea#message{
    display:block;
    margin:12px auto;
    width:90%;
    font-size:18px;
    padding:15px;
    border-radius:10px;
    resize:vertical;
    background-color: rgba(17,17,17,0.97);
    color:#ffffff;
    border:1px solid #333;
    text-align:left;
    font-family:'Share Tech Mono', monospace;
    box-shadow: inset 0 0 5px #111;
    transition: all 0.2s ease-in-out;
    min-height:120px;
  }
  textarea#message::placeholder{ color: #ffffff; opacity: 0.6; }
  textarea#message:focus{
    outline:none;
    border-color:#fff;
    box-shadow: inset 0 0 15px #fff, 0 0 25px #fff;
    transition: box-shadow 0.3s ease, border-color 0.3s ease;
  }

  /* ---------------- BUTTONS ---------------- */
  #submitButton {
    margin-top:10px;
    background: linear-gradient(145deg,#161616,#242424);
    color:#fff;
    border:2px solid #ccc;
    border-radius:10px;
    padding:15px 35px;
    font-weight:bold;
    font-family:'Orbitron',sans-serif;
    cursor:pointer;
    position:relative;
    overflow:hidden;
    text-shadow:0 0 2px #fff;
    box-shadow: 0 0 6px #ffffff33, 0 0 12px #ffffff11 inset;
    animation: ambientGlow 3.5s ease-in-out infinite alternate;
    transition: all 0.35s ease;
  }
  @keyframes ambientGlow {
    0%{ box-shadow:0 0 4px #ffffff33, 0 0 8px #ffffff11 inset; }
    100%{ box-shadow:0 0 12px #ffffff88, 0 0 18px #ffffff33 inset; }
  }
  #submitButton:hover{
    color:#000;
    background: linear-gradient(145deg,#f2f2f2,#dcdcdc);
    border-color:#fff;
    transform: translateY(-2px) scale(1.04);
    animation: hoverPulse 1.6s infinite alternate;
    box-shadow: 0 0 10px #ffffffcc, 0 0 20px #ffffff66 inset;
  }
  @keyframes hoverPulse {
    0%{ box-shadow:0 0 8px #ffffff88, 0 0 15px #ffffff33 inset; }
    100%{ box-shadow:0 0 16px #ffffffcc, 0 0 25px #ffffff66 inset; }
  }

  /* ---------------- CONTRACTS + SUMMARY LAYOUT ---------------- */
  .contracts-wrapper{
    display:flex;
    justify-content:center;
    align-items:flex-start;
    gap:10px;
    flex-wrap:nowrap;
    width:100%;
    max-width:1100px;
    box-sizing:border-box;
    z-index:2;
  }

  /* left contract image */
  .total-cost-container{
    width: 320px;
    height: 260px;
    background-size: contain;
    background-position: center;
    background-repeat: no-repeat;
    position: relative;
    border-radius: 12px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.5);
    display: none; /* hidden until submit */
    flex: 0 0 auto;
  }
  #leftContainer { background-image: url('https://raw.githubusercontent.com/OreStellar/Orestellar.github.io/refs/heads/main/images/Contract1.png'); }
  #totalCostContainer { background-image: url('https://raw.githubusercontent.com/OreStellar/Orestellar.github.io/refs/heads/main/images/Contract2.png'); }

  /* total overlay on right contract */
  #totalCostText {
    position:absolute;
    top: calc(50% + 8px);
    left: calc(50% - 42px);
    font-size:16px;
    font-weight:bold;
    color:#00ff00;
    text-shadow:0 0 12px #00ff00, 0 0 24px #00ff00;
    cursor:pointer;
    pointer-events:auto;
  }

  /* ---------------- SUMMARY: capped width + table ledger ---------------- */
  .summary-container {
    display:none; /* show after submit */
    flex-direction: column;
    align-items: stretch;
    justify-content: flex-start;
    font-family:'Orbitron', monospace;
    color: #00ff00;
    background: rgba(0,10,0,0.85);
    border: 1px solid rgba(0,255,0,0.5);
    border-radius: 12px;
    padding: 14px 18px;
    width: auto;
    max-width: 360px;    /* <-- limit width so it doesn't stretch */
    min-width: 260px;
    text-shadow: 0 0 6px #00ff00;
    box-shadow: 0 0 12px rgba(0,255,0,0.25);
    backdrop-filter: blur(6px);
    max-height:420px;
    overflow-y:auto;
    overflow-x:hidden;
    scrollbar-width: thin;
    scrollbar-color: #00ff00 transparent;
    box-sizing:border-box;
  }

  .summary-container::-webkit-scrollbar{ width:7px; }
  .summary-container::-webkit-scrollbar-thumb{
    background:#00ff00; border-radius:4px; box-shadow:0 0 10px #00ff00;
  }

  table.summary-table {
    width:100%;
    border-collapse: collapse;
    font-size:13px;
  }
  table.summary-table th, table.summary-table td {
    padding:6px 8px;
    border-bottom: 1px solid rgba(0,255,0,0.06);
    vertical-align: middle;
    white-space: nowrap;
  }
  table.summary-table th:first-child, table.summary-table td:first-child {
    text-align:left;
    white-space: normal; /* allow names to wrap if needed */
  }
  table.summary-table th {
    color: #ccffdd;
    text-shadow: 0 0 6px #00ff00;
    font-weight:700;
  }
  table.summary-table td {
    color: #00ff00;
    text-shadow: 0 0 6px #00ff00;
  }
  table.summary-table tr.unrecognized td {
    color: #ff3333;
    text-shadow: 0 0 10px #ff3333, 0 0 20px #ff0000;
  }

  .summary-total {
    margin-top:8px;
    padding-top:6px;
    border-top: 1px solid rgba(0,255,0,0.18);
    display:flex;
    justify-content:space-between;
    align-items:center;
    font-weight:bold;
    color:#00ff00;
    text-shadow: 0 0 12px #00ff00, 0 0 24px #00ff00;
    font-size:15px;
  }

  /* share button styled like submit and centered under contracts+summary */
  .share-wrapper {
    width:100%;
    display:flex;
    justify-content:center;
    margin-top:10px;
    z-index:3;
  }
  #shareButton {
    display:none; /* show after submit */
    margin-top:0;
    padding:14px 36px;
    background: linear-gradient(145deg,#161616,#242424);
    color:#fff;
    border:2px solid #ccc;
    border-radius:10px;
    font-weight:bold;
    font-family:'Orbitron',sans-serif;
    cursor:pointer;
    text-shadow:0 0 2px #fff;
    box-shadow: 0 0 6px #ffffff33, 0 0 12px #ffffff11 inset;
    transition: all 0.35s ease;
  }
  #shareButton:hover {
    color:#000;
    background: linear-gradient(145deg,#f2f2f2,#dcdcdc);
    border-color:#fff;
    transform: translateY(-2px) scale(1.04);
    animation: hoverPulse 1.6s infinite alternate;
  }

  /* small screens */
  @media (max-width:720px) {
    #logoText { font-size:3.6rem; }
    .contracts-wrapper { flex-wrap:wrap; justify-content:center; gap:14px; }
    .total-cost-container { width: 90%; height: 200px; }
    .summary-container { max-width: 92%; min-width: auto; }
  }
</style>
</head>
<body>

<!-- STARFIELD canvas -->
<canvas id="starfield"></canvas>

<!-- PAGE CONTENT -->
<div class="container-wrapper">

  <!-- HEADER -->
  <header id="myHeader" title="Click to reload">
    <h1 id="logoText"><span id="ore">Ore</span><span id="stellar">Stellar</span></h1>
  </header>

  <!-- MAIN INPUT -->
  <div class="main-container">
    <h3 class="quote-text">Copy & Paste Your Inventory Below</h3>
    <textarea id="message" rows="8" placeholder="Compressed Ytirium 90143
Jet Ochre 13527
Magma Mercoxit 40599
Compressed Mordunium 592556
Bistot 1320"></textarea>

    <button id="submitButton" disabled>Submit</button>
  </div>

  <!-- CONTRACTS + SUMMARY (inline) -->
  <div class="contracts-wrapper">

    <!-- contract 1 (left) -->
    <div id="leftContainer" class="total-cost-container" aria-hidden="true"></div>

    <!-- summary (center) -->
    <div id="summaryContainer" class="summary-container" aria-live="polite"></div>

    <!-- contract 2 (right) with total overlay -->
    <div id="totalCostContainer" class="total-cost-container" aria-hidden="true">
      <div id="totalCostText">0 ISK</div>
    </div>

  </div>

  <!-- share summary centered under the inline row -->
  <div class="share-wrapper">
    <button id="shareButton">Share Summary</button>
  </div>

</div> <!-- end container-wrapper -->

<!-- FULL expanded JS -->
<script>
/* ===========================================================
   Starfield (restored to be like earlier blueprint)
   - Canvas based starfield with clusters and twinkle
   =========================================================== */
(function initStarfield(){
  const canvas = document.getElementById('starfield');
  const ctx = canvas.getContext('2d');

  function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    createStars();
  }
  window.addEventListener('resize', resize);

  // star storage
  let stars = [];
  let clusterCount = 12;

  function createStars() {
    stars = [];
    const clusterCenters = [];
    for (let i = 0; i < clusterCount; i++) {
      clusterCenters.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height });
    }
    const totalStars = Math.floor(window.innerWidth * window.innerHeight / 600);
    for (let i = 0; i < totalStars; i++) {
      let x, y;
      if (Math.random() < 0.6) {
        const c = clusterCenters[Math.floor(Math.random() * clusterCenters.length)];
        const radius = Math.random() * 120;
        const angle = Math.random() * Math.PI * 2;
        x = c.x + radius * Math.cos(angle);
        y = c.y + radius * Math.sin(angle);
      } else {
        x = Math.random() * canvas.width;
        y = Math.random() * canvas.height;
      }
      stars.push({
        x: x,
        y: y,
        size: Math.random() * 1.5 + 0.2,
        color: ["#ffffff","#ff99aa","#99ccff","#f0f0f0"][Math.floor(Math.random()*4)],
        phase: Math.random() * Math.PI * 2,
        twinkle: Math.random() < 0.35,
        baseAlpha: 0.7 + Math.random() * 0.3
      });
    }
  }

  createStars();

  let lastBrightTime = 0;
  let nextBrightInterval = 7000 + Math.random() * 8000;

  function draw(time=0){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    if (time - lastBrightTime > nextBrightInterval) {
      lastBrightTime = time;
      nextBrightInterval = 7000 + Math.random() * 8000;
      for (let i=0;i<2;i++){
        const s = stars[Math.floor(Math.random()*stars.length)];
        s.isBright = true; s.brightStart = time; s.brightEnd = time + 2000 + Math.random()*1000;
      }
    }
    for (const s of stars) {
      let alpha = s.baseAlpha;
      if (s.twinkle) alpha = 0.6 + 0.4 * Math.sin(time*0.002 + s.phase);
      if (s.isBright && time >= s.brightStart && time < s.brightEnd) alpha = 1;
      else s.isBright = false;

      ctx.beginPath();
      ctx.arc(s.x, s.y, s.size, 0, Math.PI*2);
      ctx.fillStyle = s.color;
      ctx.globalAlpha = alpha;
      ctx.shadowBlur = alpha===1 ? s.size*8 : s.size*4;
      ctx.shadowColor = s.color;
      ctx.fill();
    }
    ctx.globalAlpha = 1;
    requestAnimationFrame(draw);
  }
  resize();
  requestAnimationFrame(draw);
})();

/* ===========================================================
   Prices: fetch CSV and parse the 150% column
   CSV: https://raw.githubusercontent.com/OreStellar/Orestellar.github.io/main/data/prices.csv
   We parse headers, find a header containing "150%" (case-insensitive), and use that column.
   If not found, fall back to second column if reasonable.
   =========================================================== */

let normalizedPriceList = {}; // key -> number
let aliasMap = {};           // shortName -> canonical key (e.g. 'ytirium' -> 'compressed ytirium')
const CSV_URL = 'https://raw.githubusercontent.com/OreStellar/Orestellar.github.io/main/data/prices.csv';

// helper parse for safe numeric parsing
function safeParseFloat(s) {
  if (s === undefined || s === null) return NaN;
  const cleaned = String(s).trim().replace(/[^\d\.\-]/g,'');
  if (cleaned.length === 0) return NaN;
  const v = parseFloat(cleaned);
  return isNaN(v) ? NaN : v;
}

function loadCSVPrices() {
  return fetch(CSV_URL, { cache: 'no-cache' })
    .then(r => {
      if (!r.ok) throw new Error('Failed to fetch prices.csv: ' + r.status);
      return r.text();
    })
    .then(text => {
      const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
      if (lines.length === 0) return;

      // parse header to find "150%" column index
      const headerCols = lines[0].split(',').map(h => h.trim());
      let priceIdx = -1;
      for (let i=0;i<headerCols.length;i++){
        if (/150%/i.test(headerCols[i])) { priceIdx = i; break; }
      }
      // fallback: if header didn't have a 150% column, try second column
      if (priceIdx === -1 && headerCols.length > 1) priceIdx = 1;

      // parse all subsequent lines
      for (let i = 1; i < lines.length; i++) {
        const row = lines[i];
        // split on commas but only into columns (we expect simple CSV)
        const cols = row.split(',');
        if (cols.length <= 0) continue;
        const rawName = (cols[0] || '').trim();
        const rawPrice = (cols[priceIdx] !== undefined) ? cols[priceIdx] : (cols[1]||'');
        if (!rawName) continue;
        const key = rawName.toLowerCase().trim();
        const parsed = safeParseFloat(rawPrice);
        if (!isNaN(parsed)) {
          normalizedPriceList[key] = parsed;
        }
      }

      // build alias map automatically for "compressed X" -> "X"
      for (const k of Object.keys(normalizedPriceList)) {
        if (k.startsWith('compressed ')) {
          const shortName = k.replace(/^compressed\s+/,'').trim();
          if (shortName.length) {
            if (!aliasMap[shortName]) aliasMap[shortName] = k;
          }
        }
      }

      // enable submit button after load
      const submitBtn = document.getElementById('submitButton');
      if (submitBtn) submitBtn.disabled = false;
    })
    .catch(err => {
      console.error('Error loading CSV prices:', err);
      // even on error, enable submit so user can at least see unrecognized results
      const submitBtn = document.getElementById('submitButton');
      if (submitBtn) submitBtn.disabled = false;
    });
}

// call loader immediately
loadCSVPrices();

/* ===========================================================
   Utility helpers
   =========================================================== */
function normalizeNameForLookup(input) {
  if (!input) return '';
  return String(input).trim().toLowerCase().replace(/\s+/g,' ');
}

function findPrice(keyName) {
  // Attempt sequence of matches:
  // 1) exact normalized match
  // 2) alias map (shortName -> compressed name)
  // 3) compressed + name
  // 4) substring match both ways
  const n = normalizeNameForLookup(keyName);
  if (!n) return null;

  // 1) exact
  if (normalizedPriceList[n] !== undefined) return { key: n, price: normalizedPriceList[n] };

  // 2) alias
  if (aliasMap[n] && normalizedPriceList[aliasMap[n]] !== undefined) {
    return { key: aliasMap[n], price: normalizedPriceList[aliasMap[n]] };
  }

  // 3) try compressed + n
  const compressedKey = ('compressed ' + n).trim();
  if (normalizedPriceList[compressedKey] !== undefined) return { key: compressedKey, price: normalizedPriceList[compressedKey] };

  // 4) substring heuristics
  const keys = Object.keys(normalizedPriceList);
  for (let k of keys) {
    if (k.indexOf(n) !== -1 || n.indexOf(k) !== -1) {
      return { key: k, price: normalizedPriceList[k] };
    }
  }

  // none
  return null;
}

/* animate count helper */
function animateCount(el, start, end, duration=2000) {
  let startTime = null;
  function step(ts) {
    if (!startTime) startTime = ts;
    const progress = Math.min((ts - startTime) / duration, 1);
    const current = Math.floor(start + (end - start) * progress);
    el.innerText = current.toLocaleString() + ' ISK';
    if (progress < 1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

/* ===========================================================
   showContent() - parse textarea, create rows, show table
   - regex tuned to capture names (letters, hyphens, spaces) then integer qty
   - uses findPrice() to fetch unit price
   =========================================================== */
function showContent() {
  // Read input text
  const raw = document.getElementById('message').value || '';
  const regex = /([\w\-\.\' ]+?)\s+(\d+)/g; // name (letters/dashes/spaces) + quantity
  let match = null;
  const rows = [];
  let grandTotal = 0;

  while ((match = regex.exec(raw)) !== null) {
    const nameRaw = String(match[1]).trim();
    const qty = parseInt(match[2], 10) || 0;

    // find price
    const found = findPrice(nameRaw);

    if (found && typeof found.price === 'number') {
      const unit = Number(found.price);
      const total = unit * qty;
      grandTotal += total;
      rows.push({ name: nameRaw, price: unit, qty: qty, total: total, recognized: true, key: found.key });
    } else {
      rows.push({ name: nameRaw, price: '?', qty: qty, total: 'Unrecognized', recognized: false });
    }
  }

  // render summary table
  const summaryContainer = document.getElementById('summaryContainer');
  summaryContainer.innerHTML = ''; // clear

  if (rows.length === 0) {
    // show guidance if nothing parsed
    const hint = document.createElement('div');
    hint.style.color = '#ccffdd';
    hint.style.padding = '10px';
    hint.style.fontSize = '13px';
    hint.innerText = 'No valid items found. Paste lines like: "Compressed Ytirium 12345" or "Ytirium 12345"';
    summaryContainer.appendChild(hint);
  } else {
    const table = document.createElement('table');
    table.className = 'summary-table';

    // thead
    const thead = document.createElement('thead');
    const headRow = document.createElement('tr');
    const thName = document.createElement('th'); thName.innerText = 'Name'; headRow.appendChild(thName);
    const thPrice = document.createElement('th'); thPrice.innerText = 'Price'; thPrice.style.textAlign = 'right'; headRow.appendChild(thPrice);
    const thQty = document.createElement('th'); thQty.innerText = 'Quantity'; thQty.style.textAlign = 'right'; headRow.appendChild(thQty);
    const thTotal = document.createElement('th'); thTotal.innerText = 'Total'; thTotal.style.textAlign = 'right'; headRow.appendChild(thTotal);
    thead.appendChild(headRow);
    table.appendChild(thead);

    // tbody
    const tbody = document.createElement('tbody');
    rows.forEach(r => {
      const tr = document.createElement('tr');
      if (!r.recognized) tr.classList.add('unrecognized');

      const tdName = document.createElement('td'); tdName.innerText = r.name; tdName.style.textAlign = 'left'; tr.appendChild(tdName);
      const tdPrice = document.createElement('td'); tdPrice.innerText = (r.price === '?' ? '?' : formatNumber(r.price)); tdPrice.style.textAlign = 'right'; tr.appendChild(tdPrice);
      const tdQty = document.createElement('td'); tdQty.innerText = formatNumber(r.qty); tdQty.style.textAlign = 'right'; tr.appendChild(tdQty);
      const tdTotal = document.createElement('td'); tdTotal.innerText = (r.total === 'Unrecognized' ? 'Unrecognized' : formatNumber(r.total)); tdTotal.style.textAlign = 'right'; tr.appendChild(tdTotal);

      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    summaryContainer.appendChild(table);

    // summary total block (ledger style)
    const totalDiv = document.createElement('div');
    totalDiv.className = 'summary-total';
    const leftSpan = document.createElement('span');
    leftSpan.innerText = 'Total';
    leftSpan.style.color = '#ccffdd';
    leftSpan.style.flex = '1';
    leftSpan.style.textAlign = 'left';

    const rightSpan = document.createElement('span');
    rightSpan.innerText = formatNumber(grandTotal) + ' ISK';
    rightSpan.style.flex = '0 0 auto';
    rightSpan.style.textAlign = 'right';

    totalDiv.appendChild(leftSpan);
    totalDiv.appendChild(rightSpan);
    summaryContainer.appendChild(totalDiv);
  }

  // reveal contracts + show animated total on contract 2
  const left = document.getElementById('leftContainer');
  const right = document.getElementById('totalCostContainer');
  if (left) left.style.display = 'block';
  if (right) right.style.display = 'block';

  const totalEl = document.getElementById('totalCostText');
  if (totalEl) {
    animateCount(totalEl, 0, grandTotal, 1600);
  }

  // hide main input (as in earlier blueprint behaviour)
  const mainCard = document.querySelector('.main-container');
  if (mainCard) mainCard.style.display = 'none';

  // show summary container and share button
  if (summaryContainer) summaryContainer.style.display = 'flex';
  const shareBtn = document.getElementById('shareButton'); if (shareBtn) shareBtn.style.display = 'inline-block';
}

/* ===========================================================
   Share URL: encodes inventory and appends ?inv=<encoded>
   We will copy full encoded URL to clipboard (no external shortening)
   =========================================================== */
function copyShareUrl() {
  const inventory = document.getElementById('message').value || '';
  const encoded = encodeURIComponent(inventory);
  const url = location.origin + location.pathname + '?inv=' + encoded;
  navigator.clipboard.writeText(url).then(() => {
    const btn = document.getElementById('shareButton');
    const prev = btn.innerText;
    btn.innerText = 'Copied!';
    setTimeout(()=>{ btn.innerText = prev; }, 1300);
  }).catch(err => {
    alert('Share URL: ' + url);
  });
}

/* ===========================================================
   Hook up buttons and logo refresh
   =========================================================== */
document.getElementById('submitButton').addEventListener('click', showContent);
document.getElementById('shareButton').addEventListener('click', copyShareUrl);
document.getElementById('myHeader').addEventListener('click', ()=> location.reload() );

/* ===========================================================
   If page loaded with ?inv=... then auto populate textarea and call showContent
   Wait for prices to be loaded (up to a short timeout)
   =========================================================== */
(function autoLoadFromUrl(){
  const params = new URLSearchParams(window.location.search);
  if (!params.has('inv')) return;
  const raw = params.get('inv') || '';
  try {
    document.getElementById('message').value = decodeURIComponent(raw);
  } catch (e){
    document.getElementById('message').value = raw;
  }
  // wait until price list loaded (or after 2s) then call showContent
  const tryRun = (tries=0) => {
    if (Object.keys(normalizedPriceList).length > 0 || tries > 10) {
      // call showContent (even if prices not loaded, will show Unrecognized)
      showContent();
    } else {
      setTimeout(()=> tryRun(tries+1), 200);
    }
  };
  tryRun();
})();

/* ===========================================================
   Finished JS
   =========================================================== */
</script>
</body>
</html>
