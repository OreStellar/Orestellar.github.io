<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>OreStellar</title>

<!-- Google Font: Orbitron -->
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet">

<!-- LZString for URL compression -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>

<style>
/* ===== BASE ===== */
html,body{margin:0;padding:0;height:100%;overflow:hidden;background:#000;font-family:monospace;color:#fff;}
canvas#starfield{position:fixed;top:0;left:0;width:100%;height:100%;z-index:0;pointer-events:none;}

/* Container */
.container-wrapper{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;gap:20px;padding:20px;z-index:2;position:relative;}

/* Logo */
#myHeader{display:flex;justify-content:center;align-items:center;flex-direction:column;text-align:center;width:100%;max-width:650px;margin-bottom:30px;cursor:pointer;z-index:2;}
#logoText{display:inline;font-family:'Orbitron',sans-serif;font-weight:700;font-size:4.5rem;letter-spacing:0;color:rgba(255,255,255,0.1);transform:skewX(-8deg);}
#logoText span{display:inline;color:rgba(255,255,255,0.1);text-shadow:none;}
@keyframes softGlow{0%,100%{text-shadow:0 0 5px #fff;color:rgba(255,255,255,0.75);}50%{text-shadow:0 0 15px #fff;color:rgba(255,255,255,1);}}
@keyframes flickerRapid{0%,20%,40%,60%,80%,100%{color: rgba(255,255,255,1);text-shadow:0 0 10px #fff;}10%,30%,50%,70%,90%{color: rgba(255,255,255,0.1);text-shadow:none;}}
@keyframes flickerQuick{0%,50%,100%{color: rgba(255,255,255,0.1);text-shadow:none;}25%,75%{color: rgba(255,255,255,1);text-shadow:0 0 10px #fff;}}

/* Main Container */
.main-container{width:650px;max-width:90%;padding:30px;display:flex;flex-direction:column;justify-content:center;align-items:center;background-color:rgba(20,20,20,0.92);border-radius:15px;z-index:2;}
.main-container textarea#message{display:block;margin:0 auto;width:92%;font-size:18px;padding:18px;border-radius:10px;resize:vertical;background-color:rgba(17,17,17,0.97);color:#fff;border:1px solid #333;text-align:left;font-family:'Share Tech Mono',monospace;box-shadow:inset 0 0 5px #111;transition: all 0.2s ease-in-out;}
.main-container textarea#message::placeholder{color:#fff;opacity:0.6;}
textarea#message:focus{outline:none;border-color:#fff;box-shadow:inset 0 0 15px #fff,0 0 25px #fff;transition:box-shadow 0.3s ease,border-color 0.3s ease;}

/* Buttons */
.actionButton{margin-top:15px;background:linear-gradient(145deg,#161616,#242424);color:#fff;border:2px solid #ccc;border-radius:10px;padding:12px 26px;font-weight:bold;font-family:'Orbitron',sans-serif;cursor:pointer;position:relative;overflow:hidden;text-shadow:0 0 2px #fff;box-shadow:0 0 6px #ffffff33,0 0 12px #ffffff11 inset;animation:ambientGlow 3.5s ease-in-out infinite alternate;transition:all 0.35s ease;}
.actionButton:disabled{opacity:0.5;cursor:not-allowed;}
@keyframes ambientGlow{0%{box-shadow:0 0 4px #ffffff33,0 0 8px #ffffff11 inset;}100%{box-shadow:0 0 12px #ffffff88,0 0 18px #ffffff33 inset;}}

/* Contracts */
.contracts-wrapper{display:flex;justify-content:center;align-items:flex-start;gap:15px;flex-wrap:wrap;width:100%;}
.total-cost-container{width:630px;height:418px;background-size:contain;background-position:center;background-repeat:no-repeat;position:relative;border-radius:15px;box-shadow:0 4px 8px rgba(0,0,0,0.5);display:none;}
#leftContainer{background-image:url('https://raw.githubusercontent.com/OreStellar/Orestellar.github.io/refs/heads/main/images/Contract1.png');display:none;}
#totalCostContainer{background-image:url('https://raw.githubusercontent.com/OreStellar/Orestellar.github.io/refs/heads/main/images/Contract2.png');display:none;position:relative;}
#totalCostText{position:absolute;top:18px;right:20px;color:#00ff00;font-family:'Share Tech Mono',monospace;font-weight:bold;font-size:18px;text-shadow:0 0 6px #00ff00,0 0 12px #00ff00;cursor:pointer;}

/* Price Tab (circular neon) */
#priceTab{position:fixed;top:22vh;right:18px;width:48px;height:48px;border-radius:10px;background:#00ff00;color:#000;display:flex;justify-content:center;align-items:center;font-weight:700;font-size:20px;cursor:pointer;box-shadow:0 0 12px #00ff00,0 0 30px #00ff00 inset;z-index:30;transition:transform 0.18s ease, right 0.18s ease;}
#priceTab:hover{transform:translateX(-6px) scale(1.05);}

/* Floating price list */
#priceListContainer{position:fixed;top:18vh;right:78px;width:320px;max-height:60vh;overflow-y:auto;background:rgba(0,0,0,0.95);border:1px solid #00ff00;padding:10px;border-radius:10px;display:none;box-shadow:0 0 18px #00ff00;z-index:29;font-family:'Share Tech Mono',monospace;color:#00ff00;}
#priceListContainer table{width:100%;border-collapse:collapse;}
#priceListContainer th,#priceListContainer td{padding:6px 8px;border-bottom:1px solid rgba(0,255,0,0.08);font-size:13px;text-align:left;}
#priceListContainer th{font-weight:700;color:#00ff00;}

/* Summary container */
.summary-container{display:none;flex-direction:column;align-items:stretch;justify-content:flex-start;font-family:'Share Tech Mono',monospace;font-size:14px;line-height:1.4;color:#00ff00;background:rgba(0,10,0,0.95);border:2px solid #00ff00;border-radius:12px;padding:16px 20px;min-width:420px;max-width:520px;max-height:60vh;overflow-y:auto;backdrop-filter:blur(6px);box-shadow:0 0 18px rgba(0,255,0,0.25);z-index:3;}
.summary-container::-webkit-scrollbar{width:8px;}
.summary-container::-webkit-scrollbar-thumb{background:#00ff00;border-radius:6px;box-shadow:0 0 10px #00ff00;}

/* Summary table */
.summary-table{width:100%;border-collapse:collapse;table-layout:fixed;}
.summary-table th, .summary-table td {padding:8px 10px;border-bottom:1px solid rgba(0,255,0,0.06);font-size:13px;white-space:nowrap;}
.summary-table th:nth-child(1), .summary-table td:nth-child(1){text-align:left;}
.summary-table td.price, .summary-table td.quantity, .summary-table td.total-column {text-align:right;font-variant-numeric:tabular-nums;}
.summary-table tr.unrecognized td {color:#ff4444;font-weight:700;text-shadow:0 0 8px #ff3333;}
.summary-table th {color:#00ff00;text-shadow:0 0 6px #00ff00;border-bottom:1px solid rgba(0,255,0,0.15);}
.summary-total td{border-top:2px solid rgba(0,255,0,0.25);font-weight:700;text-align:right;padding-top:10px;}

/* Ledger style when shared */
.shared-ledger{font-family:'Share Tech Mono',monospace;background:rgba(0,0,0,0.98);border:none;box-shadow:none;padding:10px 14px;border-radius:6px;}
</style>
</head>
<body data-show-inventory="true">

<canvas id="starfield"></canvas>

<div class="container-wrapper">
  <header id="myHeader" title="Return home">
    <h1 id="logoText"><span id="ore">Ore</span><span id="stellar">Stellar</span></h1>
  </header>

  <div class="main-container" id="inventoryContainer">
    <h3 style="font-family:'Orbitron',sans-serif;font-weight:700;color:#fff;text-shadow:0 0 8px #fff,0 0 16px #fff,0 0 24px #00ff00;">Paste Your Inventory Below</h3>
    <textarea id="message" rows="8" placeholder="Compressed Ytirium	1,189,290	Ytirium			7,135.74 m3	658,723,945.20 ISK
Compressed Gneiss	143,582	Gneiss			7,179.10 m3	479,780,688.82 ISK"></textarea>
    <button id="submitButton" class="actionButton" disabled>Submit</button>
  </div>

  <div class="contracts-wrapper">
    <div id="leftContainer" class="total-cost-container"></div>
    <div id="summaryContainer" class="summary-container" aria-live="polite"></div>
    <div id="totalCostContainer" class="total-cost-container">
      <div id="totalCostText">0 ISK</div>
    </div>
  </div>

  <div id="priceTab" title="Open price list">₵</div>
  <div id="priceListContainer" aria-hidden="true"></div>

  <button id="shareButton" class="actionButton" style="display:none;margin-top:14px;">Share Summary</button>
</div>

<script>
/* ===== STARFIELD (slower & whiter) ===== */
const canvas = document.getElementById('starfield');
const ctx = canvas.getContext('2d');
function resizeCanvas(){ canvas.width = innerWidth; canvas.height = innerHeight; }
resizeCanvas(); addEventListener('resize', ()=>{ resizeCanvas(); createStars(); });

let stars = [];
let clusterCount = 10;
function createStars(){
  stars = [];
  const centers = [];
  for(let i=0;i<clusterCount;i++) centers.push({x: Math.random()*canvas.width, y: Math.random()*canvas.height});
  const total = Math.max(80, Math.floor(canvas.width * canvas.height / 1200));
  for(let i=0;i<total;i++){
    let x,y;
    if(Math.random() < 0.6){
      const c = centers[Math.floor(Math.random()*centers.length)];
      const r = Math.random()*140;
      const a = Math.random()*Math.PI*2;
      x = c.x + r*Math.cos(a);
      y = c.y + r*Math.sin(a);
    } else {
      x = Math.random()*canvas.width; y = Math.random()*canvas.height;
    }
    // mostly white stars, slower speeds
    const color = Math.random() < 0.9 ? '#ffffff' : (Math.random()<0.5 ? '#f0f0ff' : '#fff0f0');
    stars.push({
      x, y,
      size: Math.random()*1.4+0.3,
      color,
      speed: Math.random()*0.06 + 0.01,
      phase: Math.random()*Math.PI*2,
      twinkle: Math.random() < 0.2,
      baseAlpha: 0.85 + Math.random()*0.15
    });
  }
}
createStars();

let lastBrightTime = 0, nextBrightInterval = 7000 + Math.random()*7000;
function drawStars(time = 0){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(time - lastBrightTime > nextBrightInterval){
    lastBrightTime = time;
    nextBrightInterval = 7000 + Math.random()*7000;
    for(let i=0;i<2;i++){
      const s = stars[Math.floor(Math.random()*stars.length)];
      s.isBright = true;
      s.brightStart = time;
      s.brightEnd = time + 1200 + Math.random()*1600;
    }
  }
  for(const s of stars){
    let alpha = s.baseAlpha;
    if(s.twinkle) alpha = 0.5 + 0.4*Math.abs(Math.sin(time*0.002 + s.phase));
    if(s.isBright && time >= s.brightStart && time < s.brightEnd) alpha = 1;
    else s.isBright = false;
    ctx.beginPath();
    ctx.globalAlpha = alpha;
    ctx.fillStyle = s.color;
    ctx.shadowBlur = alpha === 1 ? s.size*8 : s.size*4;
    ctx.shadowColor = s.color;
    ctx.arc(s.x, s.y, s.size, 0, Math.PI*2);
    ctx.fill();
  }
  ctx.globalAlpha = 1;
  requestAnimationFrame(drawStars);
}
requestAnimationFrame(drawStars);

/* ===== FETCH PRICES (CSV) ===== */
let priceList = {};       // map: normalizedLowerName -> price (integer)
let canonicalNames = {};  // map normalized -> canonical display name (for nicer display)
async function fetchPrices(){
  try {
    const res = await fetch('https://raw.githubusercontent.com/OreStellar/Orestellar.github.io/main/data/prices.csv');
    const txt = await res.text();
    const rows = txt.split(/\r?\n/).slice(1); // skip header
    for(let i=0;i<rows.length;i++){
      if(i > 500) break; // safety
      const row = rows[i].trim();
      if(!row) continue;
      const cols = row.split(',');
      // first column is name; price may be in second-to-last column
      const name = cols[0].trim();
      if(!name) continue;
      const suggested = parseFloat(cols[cols.length-2]);
      const normalized = name.toLowerCase().replace(/\s+/g,' ').trim();
      if(!isNaN(suggested)){
        priceList[normalized] = Math.round(suggested);
        canonicalNames[normalized] = name;
      } else {
        // keep name present but price undefined
        canonicalNames[normalized] = name;
      }
    }
    // build helper list sorted by token count & length (longest first) for robust matching
    buildOreMatcher();
  } catch(e){
    console.error('Failed to fetch prices.csv', e);
  }
}
function buildOreMatcher(){
  oreEntries = Object.keys(canonicalNames || {}).map(k => {
    return { key: k, tokens: k.split(/\s+/).length, length: k.length };
  });
  // sort: more tokens first, then longer strings first
  oreEntries.sort((a,b)=> (b.tokens - a.tokens) || (b.length - a.length));
}

/* prepared oreEntries */
let oreEntries = [];

/* ===== HELPERS ===== */
function formatNumber(n){
  if(n === null || n === undefined || n === '-') return '-';
  if(typeof n !== 'number') return String(n);
  return n.toLocaleString();
}
function makeTotalCopyable(el){
  if(!el) return;
  el.style.cursor = 'pointer';
  el.addEventListener('click', async ()=>{
    try {
      await navigator.clipboard.writeText(el.innerText.replace(/[^0-9]/g,''));
      const original = el.innerText;
      el.innerText = 'Copied';
      setTimeout(()=> el.innerText = original, 1200);
    } catch(e){}
  });
}

/* ===== PARSER: find first ore name (from priceList), assign next numeric tokens to qty/m3/isk ===== */
function parseInventoryText(text){
  const lines = text.split(/\r?\n/);
  const inventory = [];

  for(const rawLine of lines){
    const line = rawLine.trim();
    if(!line) continue;

    // split tokens but keep punctuation as separate tokens when it's attached to units
    const tokens = line.split(/\s+/).filter(Boolean);

    let matched = null;
    let matchedStart = -1, matchedEnd = -1;

    // Attempt to find the first ore occurrence in token sequence
    outer:
    for(let start = 0; start < tokens.length; start++){
      // For each ore (sorted longest first), try to match tokens[start..]
      for(const entry of oreEntries){
        const nc = entry.key; // normalized canonical (lower-case)
        const tokenCount = entry.tokens;
        if(start + tokenCount -1 >= tokens.length) continue; // not enough tokens left
        const candidate = tokens.slice(start, start + tokenCount).join(' ').replace(/,+/g,'').toLowerCase();
        if(candidate === nc){
          matched = nc;
          matchedStart = start;
          matchedEnd = start + tokenCount - 1;
          break outer;
        }
      }
    }

    if(!matched){
      // fallback: if the line starts with a word phrase that looks like an ore (e.g., "Compressed Ytirium")
      // try scanning prefixes up to 5 tokens to form possible ore name
      for(let len = Math.min(5, tokens.length); len >=1; len--){
        const pref = tokens.slice(0,len).join(' ').replace(/,+/g,'').toLowerCase();
        if(priceList[pref] !== undefined || canonicalNames[pref]){
          matched = pref;
          matchedStart = 0;
          matchedEnd = len - 1;
          break;
        }
      }
    }

    if(!matched){
      // Can't find recognized ore. We'll try to pick a human-friendly name (first few words) and mark unrecognized.
      const nameGuess = tokens.slice(0,4).join(' ');
      inventory.push({ name: nameGuess, qty: 0, m3: null, isk: null, unrecognized: true });
      continue;
    }

    // We have a matched ore at tokens[matchedStart .. matchedEnd]
    // Now scan tokens after matchedEnd for numeric values in order:
    // 1) quantity (integer-like)
    // 2) m3 (decimal allowed) — token that has 'm3' or number followed by 'm3'
    // 3) isk (decimal allowed) — tokens with 'ISK' or large decimal numbers (commas, decimals)
    let qty = null, m3 = null, isk = null;

    // helper to strip commas and trailing non-digit characters
    function cleanNumTok(tok){
      return tok.replace(/,/g,'').replace(/[^0-9.\-]/g,'').trim();
    }

    for(let i = matchedEnd + 1; i < tokens.length; i++){
      const tok = tokens[i];
      // Check for explicit m3 or ISK tokens
      if(/m3/i.test(tok) || /m3$/i.test(tok) || /^m3$/i.test(tok) || /m³/i.test(tok)){
        // maybe previous token was number
        const prev = tokens[i-1] || '';
        const val = parseFloat(cleanNumTok(prev));
        if(!isNaN(val) && m3 === null) m3 = val;
        // continue
        continue;
      }
      if(/isk/i.test(tok) || /isk$/i.test(tok)){
        const prev = tokens[i-1] || '';
        const val = parseFloat(cleanNumTok(prev));
        if(!isNaN(val) && isk === null) isk = val;
        continue;
      }

      // Number tokens:
      // integer-looking (quantity) -> prefer tokens without decimals
      const numeric = cleanNumTok(tok);
      if(numeric === '') continue;
      if(/^\d+$/.test(numeric) && qty === null){
        qty = parseInt(numeric,10);
        continue;
      }
      // decimals or large numbers (possible isk or m3). If qty missing and token is integer-like with commas, allow that too
      if(/^[\d,]+\.\d+$/.test(tok) || /^[\d,]+\.\d+$/.test(numeric) || /^[\d,]+$/.test(tok)){
        const val = parseFloat(numeric);
        // if it's followed by 'm3' or 'm³' in next token, assign to m3
        const next = tokens[i+1] || '';
        if(/m3|m³/i.test(next) && m3 === null){
          m3 = val; i++; continue;
        }
        // if followed by 'ISK' assign to isk
        if(/isk/i.test(next) && isk === null){
          isk = val; i++; continue;
        }
        // if qty still null and this token is integer-like, treat as qty
        if(qty === null && /^\d+$/.test(numeric)){
          qty = parseInt(numeric,10); continue;
        }
        // otherwise, if contains many digits or decimal, and isk empty, treat as isk if > 1000 OR has decimals
        if((val > 1000 || numeric.indexOf('.') !== -1) && isk === null){
          isk = val; continue;
        }
        // if none matched, and qty null, perhaps this is qty (last resort)
        if(qty === null){
          qty = parseInt(Math.round(val),10);
          continue;
        }
      }
    } // end token scan

    // If qty still null, try to find first integer anywhere before or after matched region
    if(qty === null){
      for(let i=0;i<tokens.length;i++){
        const numeric = cleanNumTok(tokens[i]);
        if(/^\d+$/.test(numeric)){
          qty = parseInt(numeric,10);
          break;
        }
      }
    }

    // prepare display name (use canonical if we have it)
    const displayName = (canonicalNames[matched] || matched).replace(/^compressed /i, 'Comp. ');

    inventory.push({
      name: displayName,
      qty: qty || 0,
      m3: m3,
      isk: isk,
      unrecognized: false
    });
  } // end lines

  return inventory;
}

/* ===== RENDER SUMMARY ===== */
function renderSummary(items, options = {sharedView:false}){
  // items: array from parseInventoryText
  const summaryContainer = document.getElementById('summaryContainer');
  let rowsHTML = '<table class="summary-table" role="table"><thead><tr><th>Name</th><th>Price</th><th>Quantity</th><th>Total</th></tr></thead><tbody>';

  let grandTotal = 0;
  items.forEach(it => {
    // if unrecognized -> name truncated to 10 chars, price/qty hyphens, total = "Unrecognized"
    if(it.unrecognized){
      const truncated = (it.name || '').slice(0,10) + (it.name && it.name.length > 10 ? '…' : '');
      rowsHTML += `<tr class="unrecognized"><td>${escapeHtml(truncated)}</td><td class="price">---</td><td class="quantity">---</td><td class="total-column">Unrecognized</td></tr>`;
      return;
    }

    // normalized key for price lookup
    const key = (it.name || '').toLowerCase().replace(/\s+/g,' ').trim();
    const normalizedKey = Object.keys(canonicalNames).find(k=>k === key) || Object.keys(canonicalNames).find(k=>canonicalNames[k].toLowerCase() === (it.name || '').toLowerCase());
    const price = normalizedKey ? (priceList[normalizedKey] || 0) : (priceList[key] || 0);
    const total = (price && it.qty) ? Math.round(price * it.qty) : 0;
    grandTotal += total;

    rowsHTML += `<tr><td>${escapeHtml(it.name)}</td><td class="price">${formatNumber(price)}</td><td class="quantity">${formatNumber(it.qty)}</td><td class="total-column">${formatNumber(total)}</td></tr>`;
  });

  rowsHTML += `<tr class="summary-total"><td colspan="3" style="text-align:left">Grand Total</td><td id="summaryTotal">${formatNumber(grandTotal)}</td></tr></tbody></table>`;

  summaryContainer.innerHTML = rowsHTML;
  // ledger style when shared
  if(options.sharedView){
    summaryContainer.classList.add('shared-ledger');
  } else {
    summaryContainer.classList.remove('shared-ledger');
  }
  summaryContainer.style.display = 'flex';

  // show contracts unless sharedView
  document.getElementById('leftContainer').style.display = options.sharedView ? 'none' : 'block';
  document.getElementById('totalCostContainer').style.display = options.sharedView ? 'none' : 'flex';
  document.getElementById('shareButton').style.display = options.sharedView ? 'none' : 'inline-block';

  // update contract total (copyable)
  const totalTextEl = document.getElementById('totalCostText');
  totalTextEl.innerText = formatNumber(grandTotal) + ' ISK';
  if(!options.sharedView){
    makeTotalCopyable(totalTextEl);
  }

  const summaryTotalEl = document.getElementById('summaryTotal');
  if(summaryTotalEl) makeTotalCopyable(summaryTotalEl);

  attachSorting(summaryContainer);
}

/* ===== safe escape for HTML injection protection in table values ===== */
function escapeHtml(s){
  if(s===null || s===undefined) return '';
  return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

/* ===== SORTING (same style as before) ===== */
function attachSorting(container){
  const table = container.querySelector('table');
  if(!table) return;
  const headers = table.querySelectorAll('th');
  headers.forEach((header, index) => {
    header.style.cursor = 'pointer';
    header.addEventListener('click', ()=>{
      const tbody = table.querySelector('tbody');
      const rows = Array.from(tbody.querySelectorAll('tr')).filter(r => !r.classList.contains('summary-total'));
      const totalRow = tbody.querySelector('.summary-total');
      const ascending = !header.classList.contains('sorted-asc');
      headers.forEach(h=>h.classList.remove('sorted','sorted-asc','sorted-desc'));
      header.classList.add('sorted');
      header.classList.toggle('sorted-asc', ascending);
      header.classList.toggle('sorted-desc', !ascending);
      rows.sort((a,b)=>{
        // unrecognized rows move to bottom
        if(a.classList.contains('unrecognized') && !b.classList.contains('unrecognized')) return 1;
        if(b.classList.contains('unrecognized') && !a.classList.contains('unrecognized')) return -1;
        const A = a.children[index].innerText.replace(/[^0-9.\-]/g,'');
        const B = b.children[index].innerText.replace(/[^0-9.\-]/g,'');
        if(index === 0){
          return ascending ? a.children[index].innerText.localeCompare(b.children[index].innerText) : b.children[index].innerText.localeCompare(a.children[index].innerText);
        } else {
          const nA = parseFloat(A || 0);
          const nB = parseFloat(B || 0);
          return ascending ? nA - nB : nB - nA;
        }
      });
      // append sorted rows back, then total row
      rows.forEach(r=>tbody.appendChild(r));
      if(totalRow) tbody.appendChild(totalRow);
    });
  });
}

/* ===== SHOW CONTENT FLOW ===== */
function showContent(prefillText){
  const t = prefillText || document.getElementById('message').value || '';
  const parsed = parseInventoryText(t);
  const isShared = !!prefillText;
  renderSummary(parsed, { sharedView: isShared });

  // hide input area if not already hidden
  if(!isShared){
    document.querySelector('.main-container').style.display = 'none';
    document.getElementById('leftContainer').style.display = 'block';
    document.getElementById('totalCostContainer').style.display = 'flex';
    document.getElementById('shareButton').style.display = 'inline-block';
  } else {
    // in shared view hide everything but summary
    document.querySelector('.main-container').style.display = 'none';
    document.getElementById('leftContainer').style.display = 'none';
    document.getElementById('totalCostContainer').style.display = 'none';
    document.getElementById('shareButton').style.display = 'none';
  }
}

/* ===== PRICE TAB / Floating Pricelist ===== */
const priceTab = document.getElementById('priceTab');
const priceListContainer = document.getElementById('priceListContainer');
priceTab.addEventListener('click', ()=> {
  if(priceListContainer.style.display === 'block'){
    priceListContainer.style.display = 'none';
    priceListContainer.setAttribute('aria-hidden','true');
  } else {
    // populate and show
    fillPriceList();
    priceListContainer.style.display = 'block';
    priceListContainer.setAttribute('aria-hidden','false');
  }
});
function fillPriceList(){
  // build rows sorted alphabetically by canonical display name
  const entries = Object.keys(canonicalNames || {}).map(k => ({ key: k, name: canonicalNames[k], price: priceList[k] || 0 }));
  entries.sort((a,b)=> a.name.localeCompare(b.name));
  let html = '<table><thead><tr><th>Ore</th><th>Price</th></tr></thead><tbody>';
  for(const e of entries){
    html += `<tr><td>${escapeHtml(e.name)}</td><td>${formatNumber(e.price)}</td></tr>`;
  }
  html += '</tbody></table>';
  priceListContainer.innerHTML = html;
}

/* ===== SUBMIT / SHARE / LOGIC ===== */
const submitBtn = document.getElementById('submitButton');
const messageBox = document.getElementById('message');

messageBox.addEventListener('input', ()=>{
  submitBtn.disabled = messageBox.value.trim() === '';
});

submitBtn.addEventListener('click', ()=>{
  showContent();
  window.scrollTo({ top: 0, behavior: 'smooth' });
});

// Share: compress into URL param s
document.getElementById('shareButton').addEventListener('click', async ()=>{
  const msg = document.getElementById('message').value.trim();
  if(!msg) return;
  const compressed = LZString.compressToEncodedURIComponent(msg);
  const url = `${location.origin}${location.pathname}?s=${compressed}`;
  try {
    await navigator.clipboard.writeText(url);
    const btn = document.getElementById('shareButton');
    const orig = btn.innerText;
    btn.innerText = 'Copied';
    setTimeout(()=> btn.innerText = orig, 1400);
  } catch(e){
    alert('Failed to copy URL.'); console.error(e);
  }
});

/* ===== AUTO-LOAD FROM URL (shared view) ===== */
window.addEventListener('load', ()=>{
  // fetch prices first
  fetchPrices().then(()=>{
    // build matcher now that priceList loaded
    // check URL param
    const params = new URLSearchParams(window.location.search);
    const s = params.get('s');
    if(s){
      const text = LZString.decompressFromEncodedURIComponent(s);
      if(text){
        showContent(text);
        // show only summary ledger style
        const summaryContainer = document.getElementById('summaryContainer');
        summaryContainer.classList.add('shared-ledger');
        // ensure floating pricelist hidden
        priceListContainer.style.display = 'none';
      }
    }
  });
});

/* ===== LOGO CLICK (restore original behavior) ===== */
document.getElementById('myHeader').addEventListener('click', ()=>{
  // reset to base URL (same page)
  window.location.href = window.location.origin + window.location.pathname;
});

/* ===== LOGO ANIMATION: flicker twice then once then softGlow (restored) ===== */
window.addEventListener('load', ()=>{
  const ore = document.getElementById('ore'), stellar = document.getElementById('stellar');
  ore.style.animation = 'flickerRapid 0.3s linear forwards';
  setTimeout(()=> { ore.style.animation = 'softGlow 6s infinite'; }, 300);
  setTimeout(()=>{
    stellar.style.animation = 'flickerRapid 0.3s linear forwards';
    setTimeout(()=>{ stellar.style.animation = 'softGlow 6s infinite'; }, 300);
  },400);
  setTimeout(()=>{
    ore.style.animation = 'flickerQuick 0.3s linear forwards';
    stellar.style.animation = 'flickerQuick 0.3s linear forwards';
    setTimeout(()=>{ ore.style.animation='softGlow 6s infinite'; stellar.style.animation='softGlow 6s infinite'; },300);
  },1100);
});
</script>
</body>
</html>
