<!DOCTYPE html>
<html>
<head>
<title>OreStellar</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<style>
html,body{
  background:black;
  color:white;
  margin:0;
  padding:0;
  height:100%;
}
.container-wrapper{
  display:flex;
  justify-content:center;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
  padding:20px;
}
.total-cost-container{
  width:630px;
  height:418px;
  background-size:contain;
  background-repeat:no-repeat;
  background-position:center;
  display:none;
  border:2px solid rgba(0,255,0,0.3);
  border-radius:12px;
  transition:opacity 0.8s ease;
  opacity:0;
}
.total-cost-container.show{
  display:block;
  opacity:1;
}
.main-container{
  width:650px;
  height:450px;
  background:#333;
  border-radius:20px;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  box-shadow:0 0 20px rgba(255,255,255,0.1);
}
.quote-text{
  font-style:italic;
  font-weight:bold;
  color:white;
  text-shadow:0 0 10px #fff,0 0 20px #bff;
  animation:pulseGlow 2s infinite alternate;
}
@keyframes pulseGlow{
  0%{text-shadow:0 0 5px #fff;}
  100%{text-shadow:0 0 20px #9f9;}
}
.full-width-textarea{width:90%;height:160px;margin-bottom:15px;border-radius:8px;}
#submitButton{
  background:white;
  color:black;
  padding:10px 25px;
  border:none;
  border-radius:10px;
  cursor:pointer;
  box-shadow:0 0 15px white;
  transition:all 0.3s;
}
#submitButton:hover{
  background:#eaffea;
  box-shadow:0 0 25px #2fff1c;
}
.w3-modal{
  display:none;
  position:fixed;
  z-index:999;
  left:0;top:0;
  width:100%;height:100%;
  background:rgba(0,0,0,0.9);
}
.w3-modal-content{
  background:radial-gradient(circle,#111,#000);
  margin:10% auto;
  padding:20px;
  border-radius:15px;
  color:#b8ffbe;
  width:400px;
  text-align:center;
  box-shadow:0 0 30px #2fff1c;
  border:2px solid #2fff1c;
}
#popupTotalPrice{
  font-size:28px;
  font-weight:bold;
  color:white;
  text-shadow:0 0 15px #00ff6e,0 0 30px #2fff1c;
  animation:pulse 1.5s infinite alternate;
}
@keyframes pulse{
  0%{text-shadow:0 0 10px #00ff6e;}
  100%{text-shadow:0 0 30px #2fff1c;}
}
</style>

<script>
let priceList = {};
let csvLoaded = false;

async function loadPrices() {
  try {
    const response = await fetch("data/prices.csv");
    if (!response.ok) throw new Error("CSV not found");
    const csv = await response.text();
    const lines = csv.trim().split("\n");
    const headers = lines[0].split(",");
    const priceIndex = headers.findIndex(h => h.toLowerCase().includes("150%"));
    for (let i=1;i<lines.length;i++){
      const parts = lines[i].split(",");
      const name = parts[0].trim();
      const price = parseFloat(parts[priceIndex]);
      if (!isNaN(price)) priceList[name] = price;
    }
    csvLoaded = true;
    console.log("âœ… CSV loaded:", Object.keys(priceList).length, "ores");
  } catch(e){
    console.error("âš ï¸ Failed to load CSV:", e);
  }
}

function formatNumber(num){return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",");}

function animateValue(id, start, end, duration){
  const obj=document.getElementById(id);
  let startTime=null;
  function step(time){
    if(!startTime) startTime=time;
    const progress=Math.min((time-startTime)/duration,1);
    const val=start+(end-start)*progress;
    obj.innerText=formatNumber(val.toFixed(2))+" ISK";
    if(progress<1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

function showContent(){
  console.log("ðŸ“¨ Submit button clicked");

  // fade in both contract containers
  const left = document.getElementById('leftContainer');
  const right = document.getElementById('totalCostContainer');
  left.classList.add('show');
  right.classList.add('show');

  // open popup modal
  const modal=document.getElementById('totalPriceModal');
  modal.style.display='block';

  // perform ore price calc
  const input=document.getElementById('message').value;
  const regex=/([\w\s]+?)\s+(\d+)/g;
  let match,total=0;
  let unknown=[];
  while((match=regex.exec(input))!==null){
    const item=match[1].trim();
    const qty=parseInt(match[2]);
    if(priceList[item]) total+=qty*priceList[item];
    else unknown.push(item);
  }
  if(!csvLoaded) total=9999999; // fallback for testing

  animateValue("popupTotalPrice",0,total,1500);

  if(unknown.length>0){
    document.getElementById('unrecognizedItemsText').innerText="Unrecognized items: "+unknown.join(", ");
    document.getElementById('unrecognizedItemsContainer').classList.remove("hidden");
  }
}

document.getElementById("submitButton").addEventListener("click", showContent);
document.getElementById("closeTotalModal").addEventListener("click", ()=>document.getElementById("totalPriceModal").style.display="none");
document.getElementById("closeBtn").addEventListener("click", ()=>document.getElementById("totalPriceModal").style.display="none");

loadPrices();
</script>
</body>
</html>
