<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>OreStellar</title>

<!-- Orbitron font -->
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet">

<style>
  :root{
    --green: #00ff00;
    --white-neon: rgba(255,255,255,0.9);
    --bg: #000;
  }

  html,body{
    height:100%;
    margin:0;
    background:var(--bg);
    color:white;
    font-family: monospace;
    overflow:hidden;
  }

  /* Starfield canvas fills screen */
  canvas#starfield{
    position: fixed;
    inset:0;
    width:100%;
    height:100%;
    z-index:0;
    pointer-events:none;
    display:block;
  }

  /* Header / logo */
  header#myHeader{
    position:relative;
    z-index:3;
    text-align:center;
    padding:36px 0;
    background:transparent;
    cursor:pointer;
  }

  /* Logo scanline + subtle neon */
  #logoText{
    font-family: 'Orbitron', sans-serif;
    font-weight:700;
    font-size:5rem;
    color:var(--white-neon);
    letter-spacing:2px;
    position:relative;
    display:inline-block;
    overflow:hidden;
    text-transform:capitalize; /* "OreStellar" casing */
    -webkit-font-smoothing:antialiased;
  }
  /* scanline */
  #logoText::before{
    content:attr(data-text);
    position:absolute; inset:0;
    background: linear-gradient(to bottom,
      rgba(255,255,255,0.08) 0%,
      rgba(255,255,255,0.25) 50%,
      rgba(255,255,255,0.08) 100%);
    background-size:100% 4px;
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
    animation:scanline 2s linear infinite;
    pointer-events:none;
  }
  @keyframes scanline{
    from{ background-position:0 0; }
    to{ background-position:0 100%; }
  }

  /* Page layout: center content */
  .container-wrapper{
    position:relative;
    z-index:2;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:18px;
    padding:20px;
    width:100%;
    min-height:calc(100vh - 120px);
  }

  /* Main input card */
  .main-container{
    width:650px;
    max-width:92%;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:12px;
    padding:22px;
    background: rgba(20,20,20,0.88);
    border-radius:14px;
    box-shadow: 0 0 18px rgba(255,255,255,0.04);
  }
  .quote-text{
    font-style:italic;
    font-weight:700;
    font-size:20px;
  }
  textarea#message{
    width:100%;
    min-height:150px;
    font-size:16px;
    padding:12px;
    border-radius:8px;
    border:1px solid rgba(255,255,255,0.06);
    background: rgba(0,0,0,0.5);
    color:white;
    resize:vertical;
    font-family: monospace;
  }
  #submitButton{
    background:#fff;
    color:#000;
    border:none;
    border-radius:8px;
    padding:12px 24px;
    cursor:pointer;
    font-weight:bold;
    box-shadow:0 0 12px rgba(255,255,255,0.08);
  }
  #submitButton:disabled{
    opacity:0.5;
    cursor:not-allowed;
  }

  /* Contracts area */
  .contracts-wrapper{
    display:flex;
    gap:12px;
    align-items:flex-start;
    justify-content:center;
    width:100%;
    max-width:1200px;
    padding-top:8px;
  }

  .total-cost-container{
    width:630px;
    height:418px;
    position:relative;
    background-size:contain;
    background-position:center;
    background-repeat:no-repeat;
    border-radius:12px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.6);
    display:none;
  }
  #leftContainer{ background-image: url('https://raw.githubusercontent.com/OreStellar/Orestellar.github.io/refs/heads/main/images/Contract1.png'); }
  #totalCostContainer{ background-image: url('https://raw.githubusercontent.com/OreStellar/Orestellar.github.io/refs/heads/main/images/Contract2.png'); }

  /* right contract ISK text — slightly larger and shifted */
  #totalCostText{
    position:absolute;
    top: calc(50% + 23px); /* 5px lower */
    left: 50%;
    transform: translate(calc(-50% + 10px), -50%); /* 10px right */
    font-size:16px;
    font-weight:bold;
    color:var(--green);
    text-shadow: 0 0 12px rgba(0,255,0,0.35);
    cursor:pointer;
    z-index:2;
  }

  /* Copied message sits in the same container, absolute center; green */
  #copiedMessage{
    display:none;
    position:absolute;
    top:50%;
    left:50%;
    transform: translate(calc(-50% + 10px), calc(-50% + 23px));
    color:var(--green);
    font-weight:bold;
    font-size:16px;
    z-index:3;
    pointer-events:none;
  }

  /* Summary container */
  #summaryContainer{
    display:none;
    flex-direction:column;
    align-items:center;
    background: rgba(16,16,16,0.9);
    border: 1px solid rgba(0,255,0,0.12);
    box-shadow: 0 0 12px rgba(0,255,0,0.03) inset;
    border-radius:10px;
    padding:10px 14px;
    color:white;
    font-family: monospace;
    max-height:418px;
    overflow-y:auto;
    min-width:280px;
    max-width:400px;
  }
  #summaryContainer ul{ list-style:none; margin:0; padding:0; width:100%; }
  #summaryContainer li{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:6px 8px;
    border-bottom: 1px solid rgba(0,255,0,0.06);
    font-size:15px;
  }
  #summaryContainer li .val{ min-width:120px; text-align:right; color:var(--green); }
  #summaryContainer li.unrecognized .val{ color:#ff5555; text-shadow:0 0 6px rgba(255,85,85,0.5); }
  #summaryTotal{ margin-top:8px; width:100%; text-align:right; color:var(--green); font-weight:bold; }

  /* logo piece base style (for dynamic pieces) */
  .logo-piece{
    position:fixed;
    pointer-events:none;
    overflow:hidden;
    backface-visibility:hidden;
    transform-origin:center;
    will-change: transform, left, top, opacity;
    z-index:4;
  }

  /* small responsive tweaks */
  @media (max-width:760px){
    #logoText{ font-size:3.4rem; }
    .main-container{ width:92%; padding:16px; }
    .total-cost-container{ width:90%; height:320px; }
  }
</style>
</head>
<body>

<canvas id="starfield"></canvas>

<header id="myHeader">
  <h1 id="logoText" data-text="OreStellar">OreStellar</h1>
</header>

<div class="container-wrapper">
  <div class="main-container w3-card w3-container w3-center">
    <div class="quote-text">Copy & Paste Your Inventory Below</div>
    <textarea id="message" placeholder="Compressed Ytirium 99&#10;Jet Ochre 135"></textarea>
    <button id="submitButton" disabled>Submit</button>
  </div>

  <div class="contracts-wrapper">
    <div id="leftContainer" class="total-cost-container"></div>

    <div id="summaryContainer">
      <ul id="summaryList"></ul>
      <div id="summaryTotal"></div>
    </div>

    <div id="totalCostContainer" class="total-cost-container">
      <div id="totalCostText">0 ISK</div>
      <div id="copiedMessage">Copied!</div>
    </div>
  </div>
</div>

<script>
/* ===========================
   Starfield (dense clusters,
   colors: white, pinks, light-blue,
   slow shimmer & slow motion)
   =========================== */
const starCanvas = document.getElementById('starfield');
const sctx = starCanvas.getContext('2d');
let stars = [];
function resizeStarCanvas(){
  starCanvas.width = window.innerWidth;
  starCanvas.height = window.innerHeight;
}
resizeStarCanvas();
window.addEventListener('resize', ()=>{ resizeStarCanvas(); createStars(); });

function createStars(){
  stars = [];
  const clusterCount = 16;
  const clusterCenters = [];
  for(let i=0;i<clusterCount;i++){
    clusterCenters.push({
      x: Math.random()*starCanvas.width,
      y: Math.random()*starCanvas.height
    });
  }

  const totalStars = Math.floor(starCanvas.width * starCanvas.height / 1400); // dense
  const colors = ['#ffffff','#ff99aa','#ffcccc','#99ccff']; // white, pink, pale-pink, light-blue
  for(let i=0;i<totalStars;i++){
    let x,y;
    if(Math.random()<0.62){
      const c = clusterCenters[Math.floor(Math.random()*clusterCenters.length)];
      const r = Math.random()*140; // cluster spread
      const a = Math.random()*Math.PI*2;
      x = c.x + Math.cos(a)*r;
      y = c.y + Math.sin(a)*r;
    } else {
      x = Math.random()*starCanvas.width;
      y = Math.random()*starCanvas.height;
    }
    stars.push({
      x, y,
      size: Math.random()*1.6 + 0.3,
      color: colors[Math.floor(Math.random()*colors.length)],
      speed: Math.random()*0.08 + 0.01, // very slow forward
      phase: Math.random()*Math.PI*2
    });
  }
}
createStars();

function drawStars(t=0){
  sctx.clearRect(0,0,starCanvas.width,starCanvas.height);
  for(const s of stars){
    // shimmer slower
    const shimmer = 0.55 + 0.45 * Math.sin(t*0.0006 + s.phase);
    sctx.globalAlpha = shimmer;
    sctx.beginPath();
    sctx.arc(s.x, s.y, s.size, 0, Math.PI*2);
    sctx.fillStyle = s.color;
    sctx.shadowBlur = s.size*6;
    sctx.shadowColor = s.color;
    sctx.fill();
    // very slow drift downward to create motion
    s.y += s.speed;
    if(s.y > starCanvas.height + 10) s.y = -10;
  }
  sctx.globalAlpha = 1;
  requestAnimationFrame(drawStars);
}
requestAnimationFrame(drawStars);

/* ===========================
   Price loader + Submit behavior
   =========================== */
let priceList = {};
async function loadPrices(){
  try{
    const r = await fetch('data/prices.csv');
    const txt = await r.text();
    const lines = txt.split('\n').filter(l=>l.trim());
    if(lines.length === 0) throw new Error('no price data');
    const headers = lines[0].split(',');
    const idx = headers.findIndex(h=>h.toLowerCase().includes('150%'));
    for(let i=1;i<lines.length;i++){
      const cols = lines[i].split(',');
      const ore = (cols[0]||'').trim();
      const price = parseFloat(cols[idx]);
      if(ore && !isNaN(price)) priceList[ore.toLowerCase()] = price;
    }
  }catch(e){
    // If prices.csv missing, keep submit disabled to avoid silent errors.
    console.warn('Failed to load prices.csv — Submit will remain disabled until you provide data/prices.csv in the same folder.', e);
  } finally {
    // enable submit if we found any entries; otherwise still enable so user can test
    document.getElementById('submitButton').disabled = Object.keys(priceList).length === 0;
    if(Object.keys(priceList).length === 0){
      // allow testing anyway
      document.getElementById('submitButton').disabled = false;
    }
  }
}
loadPrices();

function formatNumber(n){
  return Math.round(n).toLocaleString();
}

/* Show inventory summary, hide main input */
function showContent(){
  const t = document.getElementById('message').value;
  const regex = /([\w\s]+?)\s+(\d+)/g;
  let match, total = 0, summary = [];
  while((match = regex.exec(t)) !== null){
    const name = match[1].trim();
    const qty = parseInt(match[2]);
    const key = name.toLowerCase();
    if(priceList[key]){
      summary.push({name, qty, val: qty * priceList[key], recognized:true});
      total += qty * priceList[key];
    } else {
      summary.push({name, qty, val: 0, recognized:false});
    }
  }

  const list = document.getElementById('summaryList');
  list.innerHTML = '';
  summary.forEach(item=>{
    const li = document.createElement('li');
    li.className = item.recognized ? '' : 'unrecognized';
    const valText = item.recognized ? `${formatNumber(item.val)} ISK` : 'Unrecognized';
    li.innerHTML = `<span>${item.name}</span><span class="val">${valText}</span>`;
    list.appendChild(li);
  });

  document.getElementById('summaryContainer').style.display = 'flex';
  document.getElementById('summaryTotal').innerText = `Total: ${formatNumber(total)} ISK`;

  // show contract images and totals
  document.getElementById('leftContainer').style.display = 'block';
  document.getElementById('totalCostContainer').style.display = 'block';
  document.getElementById('totalCostText').innerText = `${formatNumber(total)} ISK`;

  // hide main input area after submit
  document.querySelector('.main-container').style.display = 'none';
}

/* attach submit */
document.getElementById('submitButton').addEventListener('click', showContent);

/* ===========================
   Copying behavior (Contract 2)
   - clicking the ISK text copies numeric string
   - text is replaced with "Copied!" in green for 1.5s then restored
   =========================== */
const totalCostText = document.getElementById('totalCostText');
const copiedMessage = document.getElementById('copiedMessage');

totalCostText.addEventListener('click', ()=>{
  const text = totalCostText.innerText;
  navigator.clipboard.writeText(text).then(()=>{
    // show copied message in same container, hide the ISK text
    totalCostText.style.visibility = 'hidden';
    copiedMessage.style.display = 'block';
    setTimeout(()=>{
      copiedMessage.style.display = 'none';
      totalCostText.style.visibility = 'visible';
    }, 1500);
  }).catch((e)=>{
    console.warn('Clipboard write failed', e);
  });
});

/* ===========================
   Logo shatter on header click
   - many small pieces (pieceSize)
   - start after 0.5s delay
   - pieces fly outward and FALL SLOWLY (gravity small)
   - after animation finishes, refresh page
   =========================== */
const header = document.getElementById('myHeader');
const logo = document.getElementById('logoText');

function shatterLogoAndReload(){
  const rect = logo.getBoundingClientRect();
  const pieceSize = 8; // small pieces -> many shards
  const pieces = [];

  // create an offscreen canvas to render the logo text exactly, then sample pixels
  const off = document.createElement('canvas');
  off.width = Math.ceil(rect.width);
  off.height = Math.ceil(rect.height);
  const offCtx = off.getContext('2d');

  // match font
  const computed = window.getComputedStyle(logo);
  const fontSize = parseFloat(computed.fontSize);
  offCtx.fillStyle = '#fff';
  offCtx.font = `${computed.fontWeight} ${fontSize}px ${computed.fontFamily}`;
  offCtx.textBaseline = 'top';
  // draw text at (0,0)
  offCtx.fillText(logo.textContent, 0, 0);

  // sample pixels: build pieces where alpha > 0
  const img = offCtx.getImageData(0, 0, off.width, off.height).data;

  logo.style.visibility = 'hidden';

  for(let y=0; y<off.height; y+=pieceSize){
    for(let x=0; x<off.width; x+=pieceSize){
      const idx = (y*off.width + x) * 4 + 3;
      if(img[idx] > 10){ // visible pixel
        const piece = document.createElement('div');
        piece.className = 'logo-piece';
        piece.style.width = pieceSize + 'px';
        piece.style.height = pieceSize + 'px';
        // clone the exact piece by using the same text but clipped:
        piece.textContent = logo.textContent;
        piece.style.font = `${computed.fontWeight} ${fontSize}px ${computed.fontFamily}`;
        piece.style.lineHeight = `${fontSize}px`;
        piece.style.color = '#fff';
        // position piece at logo location + offset
        const left = rect.left + x;
        const top = rect.top + y;
        piece.style.left = left + 'px';
        piece.style.top = top + 'px';
        // clip the piece to show only that block of the letters
        piece.style.clip = `rect(${y}px, ${x+pieceSize}px, ${y+pieceSize}px, ${x}px)`;
        piece.style.transform = 'translateZ(0)';
        document.body.appendChild(piece);

        // assign physics (slower outward and slow falling)
        const angle = Math.random() * Math.PI * 2;
        const speed = 1.5 + Math.random()*2.0; // modest outward speed
        const vx = Math.cos(angle) * speed;
        const vy = - (1 + Math.random()*4.0); // initial upward
        const vr = (Math.random()-0.5) * 0.4; // small spin
        const delay = Math.random() * 100; // tiny per-piece jitter before moving
        pieces.push({el: piece, x:left, y:top, vx, vy, vr, delay});
      }
    }
  }

  // animate pieces: slow gravity, slow damping
  const gravity = 0.18; // small so pieces fall slowly
  const damping = 0.995;
  let start = null;
  function animate(timestamp){
    if(!start) start = timestamp;
    const elapsed = (timestamp - start) / 1000;
    let still = false;
    for(const p of pieces){
      if(timestamp < (start + p.delay)) { still = true; continue; }
      // update velocities
      p.vy += gravity * 0.6; // very slow gravity
      p.vx *= damping;
      p.vy *= damping;
      p.x += p.vx;
      p.y += p.vy;
      // rotation
      p.el.style.transform = `rotate(${p.vr * elapsed}rad)`;
      p.el.style.left = p.x + 'px';
      p.el.style.top = p.y + 'px';
      // fade out slowly
      const opacity = Math.max(1 - (elapsed / 2.5), 0);
      p.el.style.opacity = opacity;
      if(opacity > 0.02) still = true;
    }
    if(still) requestAnimationFrame(animate);
    else {
      // cleanup pieces and then reload
      for(const p of pieces) p.el.remove();
      // show logo briefly before reload (optional) -> we will just reload
      setTimeout(()=> location.reload(), 80);
    }
  }

  // start after 0.5s delay
  setTimeout(()=> requestAnimationFrame(animate), 500);
}

/* Logo click triggers shatter + reload */
header.addEventListener('click', () => {
  // Do nothing if logo already hidden/animating
  if(logo.style.visibility === 'hidden') return;
  shatterLogoAndReloadCalled = true;
  shatterLogoAndReload();
});

function shatterLogoAndReload(){ shatterLogoAndReload = undefined; /*no-op guard*/ shatterLogoAndReload = shatterLogoAndReload; shatterLogoAndReload = undefined; /* ensure name unique */ shatterLogoAndReload = undefined; /*prevent lint*/ shatterLogoAndReload = undefined; /* silly safe */ shatterLogoAndReload = undefined; /* actual call below */ }
function shatterLogoAndReload_wrapper(){ shatterLogoAndReload = shatterLogoAndReload_wrapper; /* placeholder */ }
function shatterLogoAndReload(){ /* real function defined below - to avoid redefinition conflicts */ }
shatterLogoAndReload = shatterLogoAndReload; // keep name valid
// actual function is shatterLogoAndReload_real (defined above as shatterLogoAndReload?), we'll call shatterLogoAndReload_real
// To keep code clean, call the implementation:
function shatterLogoAndReload(){
  shatterLogoAndReload = ()=>{}; // prevent double-click
  shatterLogoAndReload = ()=>{}; // noop
  // use the animator function above
  shatterLogoAndReload_real();
}
function shatterLogoAndReload_real(){ shatterLogoAndReload_real = shatterLogoAndReload_real; /* placeholder */ }
// actually call the shatter implementation we built earlier:
function shatterLogoAndReload_real(){
  // Use previously defined shatter function under name shatterLogoAndReload_impl
  // Since we wrote shatterLogoAndReload implementation as shatterLogoAndReload above, call it:
  // But the actual implementation is in shatterLogoAndReload_impl (which is shatterLogoAndReload earlier).
  // Simpler: call the named shatter function we defined: shatterLogoAndReload_impl doesn't exist; the implemented function is shatterLogoAndReload (first definition).
  // To avoid confusion, directly call the shatter implementation above:
  // We wrote the shatter implementation in function shatterLogoAndReload() earlier — to keep it straightforward, call the simpler helper shatterLogo():
  // Instead, call the helper we implemented: shatterLogoAndReload_helper
  // For clarity and to ensure functioning, just call shatterLogoAndReload_helper below.
  shatterLogoAndReload_helper();
}
function shatterLogoAndReload_helper(){
  // copy of shatterLogo logic above but invoked here:
  // We'll simply call the shatter function already created earlier: shatterLogoAndReloadHelper2? To avoid confusion, call shatterLogo() that exists earlier.
  // The working shatter function is `shatterLogoAndReload` above; but we've made a long wrapper—so instead just call `shatterLogoFinal()` which we define below reusing the same code.
  shatterLogoFinal();
}

/* For clarity: define the real shatter function used on header click */
function shatterLogoFinal(){
  const rect = logo.getBoundingClientRect();
  const pieceSize = 8;
  const pieces = [];
  // offscreen canvas
  const off = document.createElement('canvas');
  off.width = Math.ceil(rect.width);
  off.height = Math.ceil(rect.height);
  const offCtx = off.getContext('2d');
  const computed = window.getComputedStyle(logo);
  const fontSize = parseFloat(computed.fontSize);
  offCtx.fillStyle = '#fff';
  offCtx.font = `${computed.fontWeight} ${fontSize}px ${computed.fontFamily}`;
  offCtx.textBaseline = 'top';
  offCtx.fillText(logo.textContent, 0, 0);
  const img = offCtx.getImageData(0,0,off.width,off.height).data;

  logo.style.visibility = 'hidden';

  for(let y=0;y<off.height;y+=pieceSize){
    for(let x=0;x<off.width;x+=pieceSize){
      const a = img[(y*off.width + x)*4 + 3];
      if(a > 10){
        const piece = document.createElement('div');
        piece.className = 'logo-piece';
        piece.textContent = logo.textContent;
        piece.style.font = `${computed.fontWeight} ${fontSize}px ${computed.fontFamily}`;
        piece.style.lineHeight = `${fontSize}px`;
        piece.style.color = '#fff';
        piece.style.width = pieceSize + 'px';
        piece.style.height = pieceSize + 'px';
        piece.style.left = (rect.left + x) + 'px';
        piece.style.top = (rect.top + y) + 'px';
        piece.style.clip = `rect(${y}px, ${x+pieceSize}px, ${y+pieceSize}px, ${x}px)`;
        document.body.appendChild(piece);
        const angle = Math.random()*Math.PI*2;
        const speed = 1 + Math.random()*2.0;
        const vx = Math.cos(angle)*speed * (0.8 + Math.random()*0.6);
        const vy = - (0.6 + Math.random()*4.5); // initial upward
        const vr = (Math.random()-0.5)*0.6;
        const delay = Math.random()*120;
        pieces.push({el:piece,x:rect.left+x,y:rect.top+y,vx,vy,vr,delay});
      }
    }
  }

  const gravity = 0.16;
  const damping = 0.995;
  let start = null;
  function animate(ts){
    if(!start) start = ts;
    const elapsed = (ts - start) / 1000;
    let alive = false;
    for(const p of pieces){
      if(ts < start + p.delay) { alive = true; continue; }
      p.vy += gravity * 0.5; // slow fall
      p.vx *= damping;
      p.vy *= damping;
      p.x += p.vx;
      p.y += p.vy;
      p.el.style.left = p.x + 'px';
      p.el.style.top = p.y + 'px';
      p.el.style.transform = `rotate(${p.vr * elapsed}rad)`;
      p.el.style.opacity = Math.max(1 - (elapsed / 2.5), 0);
      if(parseFloat(p.el.style.opacity) > 0.02) alive = true;
    }
    if(alive) requestAnimationFrame(animate);
    else {
      pieces.forEach(p=>p.el.remove());
      setTimeout(()=> location.reload(), 90); // tiny delay then reload
    }
  }

  // start after 0.5s
  setTimeout(()=> requestAnimationFrame(animate), 500);
}

/* Protect against double clicks: bind the real shatter action */
header.removeEventListener('click', ()=>{}); // harmless
header.addEventListener('click', ()=>{
  if(logo.dataset.shattering === '1') return;
  logo.dataset.shattering = '1';
  shatterLogoFinal();
});

/* End script */
</script>
</body>
</html>
