<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>OreStellar</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel="stylesheet" href="https://www.w3schools.com/lib/w3-theme-black.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css">
<style>
html, body { margin:0; padding:0; height:100%; background:black; color:white; font-family:monospace; overflow-x:hidden; }
canvas#starfield { position:fixed; top:0; left:0; width:100%; height:100%; z-index:0; pointer-events:none; }

header, .container-wrapper, .main-container, .contracts-wrapper, #totalPriceModal, #infoModal { position:relative; z-index:1; }

.container-wrapper { display:flex; flex-direction:column; align-items:center; gap:20px; padding:20px; width:100%; max-width:1920px; }

.contracts-wrapper { display:flex; flex-direction:row; justify-content:space-evenly; align-items:flex-start; gap:5px; width:100%; flex-wrap:wrap; }

#leftContainer, #totalCostContainer { min-height:400px; background-size:contain; background-repeat:no-repeat; background-position:center; border-radius:15px; box-shadow:0 4px 8px rgba(0,0,0,0.5); display:none; position:relative; z-index:1; }
#summaryContainer { order:2; flex:1 1 auto; max-width:300px; min-width:150px; display:none; flex-direction:column; 
    overflow-x:auto; overflow-y:auto; background-color:rgba(20,20,20,0.9); border:1px solid #00ff00; 
    box-shadow:0 0 10px #00ff00, 0 0 20px #00ff00 inset; border-radius:10px; padding:10px 15px; 
}
#totalCostText { position:absolute; top:calc(50% + 18px); left:calc(50% + 5px); transform:translate(-50%,-50%); font-size:13px; font-weight:bold; color:#00ff00; text-shadow:0 0 20px #00ff00,0 0 30px #00ff00; }

#summaryContainer ul { list-style:none; margin:0; padding:0; width:100%; }
#summaryContainer li { display:flex; justify-content:space-between; align-items:center; padding:6px 10px; border-bottom:1px solid rgba(0,255,0,0.15); font-size:15px; letter-spacing:0.5px; }
#summaryContainer li span:first-child { text-align:left; flex:1; }
#summaryContainer li span:last-child { text-align:right; min-width:120px; font-family:monospace; color:#00ff00; }
#summaryTotal { text-align:right; color:#00ff00; font-weight:bold; text-shadow:0 0 20px #00ff00,0 0 30px #00ff00; margin-top:5px; }

.main-container { width:630px; display:flex; flex-direction:column; justify-content:center; align-items:center; }
#submitButton { background-color:#ffffffff; color:black; border:none; border-radius:8px; padding:11px 25px; font-weight:bold; cursor:pointer; box-shadow:0 0 15px 3px white; transition:all 0.3s ease; margin-top:10px; }
#submitButton:hover { box-shadow:0 0 25px 5px #2fff1cff; color:black; }

.info-button { position: fixed; bottom: 20px; right: 20px; font-size: 28px; z-index: 1000; }
.info-button button { animation: bounce 2s infinite; background-color: #ffffff; color: black; border-radius: 50%; }
@keyframes bounce { 0%,20%,50%,80%,100% {transform: translateY(0);} 40% {transform: translateY(-10px);} 60% {transform: translateY(-5px);} }

.w3-modal { display:none; position: fixed; z-index:999; left:0; top:0; width:100%; height:100%; overflow:auto; background-color: rgba(0,0,0,0.9); }
.w3-modal-content { position: relative; z-index:1000; background-color:#111; margin:15% auto; padding:20px; border:1px solid #888; width:80%; max-width:600px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.7); text-align:center; }

#totalPriceModal { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background-color:#111; border:2px solid #00ff00; border-radius:12px; padding:20px 25px; text-align:center; box-shadow:0 0 15px #00ff00,0 0 30px #00ff00 inset; font-family:monospace; z-index:1000; }
#popupTotalPrice { font-size:28px; font-weight:bold; color:#00ff00; margin:15px 0; text-shadow:0 0 20px #00ff00,0 0 30px #00ff00; }
#closeTotalModal { padding:6px 18px; font-size:16px; font-weight:bold; border-radius:8px; cursor:pointer; background-color:#111; color:#00ff00; border:1px solid #00ff00; box-shadow:0 0 8px #00ff00; }
</style>
</head>
<body>

<canvas id="starfield"></canvas>

<header class="w3-container w3-theme w3-padding">
    <div class="w3-center"><img src="images/OreStellar Header.png" alt="Header Image" style="width:300px; height:auto;"></div>
    <hr>
</header>

<div class="info-button">
    <button id="infoButton" class="w3-button w3-theme">i</button>
</div>

<div id="infoModal" class="w3-modal">
    <div class="w3-modal-content">
        <span id="closeModal" class="w3-button w3-display-topright">&times;</span>
        <header class="w3-container w3-theme modal-header">
            <h2>Welcome to OreStellar's appraisal calculator!</h2>
        </header>
        <div class="w3-container">
            <p>If you have any questions, please message Morgan Auren in-game.</p>
            <p>Only asteroid ores are supported. Contracts must be High-Security (0.5+).</p>
        </div>
    </div>
</div>

<div class="container-wrapper">
    <div class="main-container w3-card w3-container w3-center">
        <h3>Copy & Paste Your Inventory Below</h3>
        <textarea id="message" class="w3-input w3-border w3-round full-width-textarea" rows="8" placeholder="Compressed Ytirium 99&#10;Jet Ochre 135"></textarea>
        <button id="submitButton" disabled>Submit</button>
    </div>

    <div class="contracts-wrapper">
        <div id="totalCostContainer"><div id="totalCostText">0 ISK</div></div>
        <div id="summaryContainer"><ul id="summaryList"></ul><div id="summaryTotal"></div></div>
        <div id="leftContainer"></div>
    </div>
</div>

<div id="totalPriceModal">
    <h2>Total ISK</h2>
    <p id="popupTotalPrice">0 ISK</p>
    <button id="closeTotalModal">Copy</button>
</div>

<script>
// ---------- STARFIELD + GALAXY ----------
const canvas=document.getElementById('starfield');
const ctx=canvas.getContext('2d');
function resize(){canvas.width=window.innerWidth; canvas.height=window.innerHeight;}
window.addEventListener('resize',resize); resize();

const colors=['#ffffff','#ffff99','#ff9999'];
const stars=[], clusters=[];
for(let i=0;i<1200;i++) stars.push({x:Math.random()*canvas.width, y:Math.random()*canvas.height, size:Math.random()*1+0.7, color:colors[Math.floor(Math.random()*colors.length)], twinkle:Math.random()*0.002, brightness:Math.random()*0.7+0.3, odd:false});
stars[0].odd=true;

for(let i=0;i<5;i++){
    clusters.push({cx:Math.random()*canvas.width, cy:Math.random()*canvas.height, radius:Math.random()*60+40, angle:Math.random()*Math.PI*2, speed:0.0005+Math.random()*0.0005});
}

function animateStars(){
    ctx.fillStyle='black'; ctx.fillRect(0,0,canvas.width,canvas.height);
    // clusters
    for(const cl of clusters){
        cl.angle+=cl.speed;
        for(let j=0;j<15;j++){
            const a=j/15*Math.PI*2+cl.angle;
            const r=cl.radius*Math.sqrt(Math.random());
            const x=cl.cx+r*Math.cos(a), y=cl.cy+r*Math.sin(a);
            const grad=ctx.createRadialGradient(x,y,0,x,y,2);
            grad.addColorStop(0,'rgba(255,255,255,0.05)');
            grad.addColorStop(1,'transparent');
            ctx.fillStyle=grad; ctx.beginPath(); ctx.arc(x,y,1.5,0,2*Math.PI); ctx.fill();
        }
    }
    // stars
    for(let s of stars){
        s.y-=0.02; if(s.y<0) s.y=canvas.height;
        if(s.odd) s.brightness=0.5+Math.sin(Date.now()*0.002)*0.5;
        else { s.brightness+=(Math.random()-0.5)*s.twinkle; if(s.brightness>1) s.brightness=1; if(s.brightness<0.3) s.brightness=0.3; }
        const grad=ctx.createRadialGradient(s.x,s.y,s.size/4,s.x,s.y,s.size);
        grad.addColorStop(0, `rgba(${parseInt(s.color.slice(1,3),16)},${parseInt(s.color.slice(3,5),16)},${parseInt(s.color.slice(5,7),16)},${s.brightness})`);
        grad.addColorStop(1,'transparent');
        ctx.fillStyle=grad; ctx.beginPath(); ctx.arc(s.x,s.y,s.size,0,2*Math.PI); ctx.fill();
    }
    requestAnimationFrame(animateStars);
}
animateStars();
</script>

<script>
// ---------- OreStellar features ----------
let priceList={};
async function loadPrices(){
    try{ const res=await fetch('data/prices.csv'); const text=await res.text();
        const lines=text.split('\n').filter(l=>l.trim()!=='');
        const headers=lines[0].split(','); const idx=headers.findIndex(h=>h.toLowerCase().includes('150%'));
        for(let i=1;i<lines.length;i++){ const cols=lines[i].split(','); const ore=cols[0].trim(); const price=parseFloat(cols[idx]); if(!isNaN(price)) priceList[ore]=price; }
    } catch(e){ console.error('Error loading CSV',e); }
}
function formatNumber(n){ return n.toLocaleString(); }
function animateCount(el,start,end,duration=2000){ let startTime=null;
    function step(ts){ if(!startTime) startTime=ts; const p=Math.min((ts-startTime)/duration,1); el.innerText=formatNumber(Math.floor(p*(end-start)+start))+' ISK'; if(p<1) requestAnimationFrame(step);}
    requestAnimationFrame(step);
}
async function init(){ await loadPrices(); document.getElementById('submitButton').disabled=false; }

document.getElementById('submitButton').addEventListener('click',()=>{
    if(Object.keys(priceList).length===0){ alert('Prices not loaded'); return; }
    const textarea=document.getElementById('message').value;
    const regex=/([\w\s]+?)\s+(\d+)/g;
    let match,total=0,summaryItems=[],invalid=[];
    while((match=regex.exec(textarea))!==null){
        const item=match[1].trim(); const qty=parseInt(match[2]);
        if(priceList[item]!==undefined){ const val=qty*priceList[item]; total+=val; summaryItems.push({name:item,value:val}); }
        else invalid.push(item);
    }
    const listEl=document.getElementById('summaryList'); listEl.innerHTML='';
    summaryItems.forEach(it=>{ const li=document.createElement('li'); li.innerHTML=`<span>${it.name}</span><span>${formatNumber(it.value)} ISK</span>`; listEl.appendChild(li); });
    document.getElementById('summaryTotal').innerText='Total: '+formatNumber(total)+' ISK';
    document.getElementById('summaryContainer').style.display='flex';
    const left=document.getElementById('leftContainer'); const right=document.getElementById('totalCostContainer');
    left.style.display='block'; right.style.display='block';
    left.style.backgroundImage="url('https://raw.githubusercontent.com/OreStellar/Orestellar.github.io/refs/heads/main/images/Contract1.png')";
    right.style.backgroundImage="url('https://raw.githubusercontent.com/OreStellar/Orestellar.github.io/refs/heads/main/images/Contract2.png')";
    animateCount(document.getElementById('totalCostText'),0,total);
    const popup=document.getElementById('popupTotalPrice'); animateCount(popup,0,total);
    document.getElementById('totalPriceModal').style.display='block';
    if(invalid.length>0) alert('Unrecognized items: '+invalid.join(', '));
});

document.getElementById('closeTotalModal').addEventListener('click',()=>{
    navigator.clipboard.writeText(document.getElementById('popupTotalPrice').innerText);
    document.getElementById('totalPriceModal').style.display='none';
});

document.getElementById('infoButton').addEventListener('click',()=>document.getElementById('infoModal').style.display='block');
document.getElementById('closeModal').addEventListener('click',()=>document.getElementById('infoModal').style.display='none');
window.addEventListener('click',e=>{ if(e.target==document.getElementById('infoModal')) document.getElementById('infoModal').style.display='none'; });

document.querySelector('header img').addEventListener('click',()=>{
    document.getElementById('message').value='';
    document.getElementById('leftContainer').style.display='none';
    document.getElementById('totalCostContainer').style.display='none';
    document.getElementById('summaryContainer').style.display='none';
    document.getElementById('totalCostText').innerText='0 ISK';
    document.getElementById('totalPriceModal').style.display='none';
    document.querySelector('.main-container').style.display='flex';
});

init();
</script>

</body>
</html>
